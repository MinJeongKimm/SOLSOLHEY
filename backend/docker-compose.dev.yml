# =====================================
# SOLSOLHEY Development Environment
# =====================================
# 개발환경용 Docker Compose Override



services:
  # =====================================
  # PostgreSQL - 개발환경 설정
  # =====================================
  postgres:
    environment:
      POSTGRES_DB: solsol_dev
    ports:
      - "5432:5432"  # 호스트에서 접근 가능
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      # 개발용 초기 데이터 (선택사항)
      - ./database/dev-data:/docker-entrypoint-initdb.d

  # =====================================
  # Backend - 개발환경 설정
  # =====================================  
  backend:
    build:
      context: ./solsol
      dockerfile: Dockerfile
      # 개발 모드에서는 빌드 캐시 비활성화
      args:
        - BUILDKIT_INLINE_CACHE=1
    environment:
      # 개발 프로필 활성화
      SPRING_PROFILES_ACTIVE: dev
      
      # 개발 데이터베이스
      DB_HOST: postgres
      DB_NAME: solsol_dev
      
      # 개발용 JWT 설정 (짧은 만료시간)
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-3600000}  # 1시간
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-86400000}  # 24시간
      
      # 개발용 CORS (모든 로컬 포트 허용)
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:5173,http://localhost:8080,http://127.0.0.1:3000,http://127.0.0.1:5173"
      
      # 개발용 로깅
      LOGGING_LEVEL_ROOT: DEBUG
      LOGGING_LEVEL_COM_SOLSOLHEY: DEBUG
      
      # JPA 디버깅 및 스키마 설정
      JPA_SHOW_SQL: true
      JPA_FORMAT_SQL: true
      JPA_HIBERNATE_DDL_AUTO: create-drop
      
      # 개발 도구 활성화
      SWAGGER_UI_ENABLED: true
      H2_CONSOLE_ENABLED: false  # PostgreSQL 사용하므로 비활성화
      
    ports:
      - "8080:8080"
    volumes:
      # 개발용 로그 디렉토리
      - ./logs/dev:/app/logs
      # 핫 리로드를 위한 볼륨 마운트 (선택사항)
      # - ./backend/solsol/src:/app/src:ro
    # 개발 환경에서는 더 빠른 재시작
    restart: "no"

  # =====================================
  # Redis - 개발환경
  # =====================================
  redis:
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    ports:
      - "6379:6379"  # 호스트에서 접근 가능
    volumes:
      - redis_dev_data:/data

# =====================================
# 개발용 추가 서비스
# =====================================
  # pgAdmin (PostgreSQL 관리 도구)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: solsol-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@solsolhey.com
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - solsol-network
    depends_on:
      - postgres

  # Redis Commander (Redis 관리 도구)  
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: solsol-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PORT: 6379
    ports:
      - "8081:8081"
    networks:
      - solsol-network
    depends_on:
      - redis

# =====================================
# 개발환경용 볼륨
# =====================================
volumes:
  postgres_dev_data:
    driver: local
  redis_dev_data:
    driver: local  
  pgadmin_data:
    driver: local
