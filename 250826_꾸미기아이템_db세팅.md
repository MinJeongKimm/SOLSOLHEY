# 250826 꾸미기 아이템 DB 세팅 계획 및 내용

본 문서는 기프티콘을 제외한 “꾸미기 아이템(착용템 + 배경 base/stickers)” 카탈로그를 DB(Flyway)로 관리하기 위한 마이그레이션 계획과 SQL 초안을 정리합니다. 실제 적용은 추후 커밋에서 진행합니다.

## 목표와 범위
- 목표: 프론트 상점/꾸미기 화면에서 사용할 아이템 카탈로그를 DB로 관리하고, 이미지 경로를 공개 자산 경로로 표준화
- 범위: `shop_items` 스키마 정합화 + 아이템 시드, (선택) `backgrounds` 테이블에 base 배경 시드
- 제외: 기프티콘(GIFTICON)

## 공개 자산 경로 규칙(참고)
- Assets root: `frontend/public`
- DB-cataloged families
  - backgrounds/base: `/backgrounds/base/<slug>.png` (배경화면, 마스코트 뒤 배경)
  - backgrounds/stickers: `/backgrounds/stickers/<slug>.png` (배경 위 스티커형 소품)
  - items: `/items/item_<category>_<name>.png` (예: `item_acc_glasses_heart.png`)
- DB에 기록하는 `image_url`은 위 public 경로 절대경로(`/...`)로 저장합니다.

## 마이그레이션 계획

### V2 — shop_items 스키마 정합화
- 파일: `backend/solsol/src/main/resources/db/migration/V2__alter_shop_items.sql`
- 목적: 카테고리 컬럼 추가, 이미지 URL 길이 확장, 조회 인덱스 보강
- 초안
```sql
-- 1) 카테고리 컬럼 추가
ALTER TABLE shop_items 
    ADD COLUMN IF NOT EXISTS category VARCHAR(50) NOT NULL DEFAULT 'head';

-- 2) 이미지 URL 길이 확장
ALTER TABLE shop_items 
    ALTER COLUMN image_url TYPE VARCHAR(500);

-- 3) 조회 인덱스(선택)
CREATE INDEX IF NOT EXISTS idx_shop_items_type ON shop_items(type);
CREATE INDEX IF NOT EXISTS idx_shop_items_category ON shop_items(category);
```

### V3 — 꾸미기 아이템 카탈로그 시드 (EQUIP + BACKGROUND)
- 파일: `backend/solsol/src/main/resources/db/migration/V3__seed_customization_catalog.sql`
- 원칙
  - 멱등: 동일 `name` 존재 시 삽입 skip
  - type: `EQUIP | BACKGROUND`
  - category: `head | clothing | accessory | base | sticker`
  - image_url: 공개 경로(`/...`) 고정
  - price: 합리적 분포(예: wearable 100~500, base 400~800, sticker 100~400)
- 초안 예시
```sql
-- ========== EQUIP: 착용 아이템 ==========
INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT '파랑 모자', '기본 파란 색상 모자', 200, 'EQUIP', '/items/item_head_hat_blue.png', 'head', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = '파랑 모자');

INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT '하트 안경', '하트 프레임 안경', 300, 'EQUIP', '/items/item_accessory_glasses_heart.png', 'accessory', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = '하트 안경');

INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT '화이트 티셔츠', '깔끔한 기본 화이트 티셔츠', 250, 'EQUIP', '/items/item_clothing_tshirt_white.png', 'clothing', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = '화이트 티셔츠');

-- (필요 시 카테고리별로 2~4개 추가)

-- ========== BACKGROUND: base(배경화면) ==========
INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT '기본 방(블루)', '꾸미기용 기본 방 배경', 500, 'BACKGROUND', '/backgrounds/base/bg_room_basic.png', 'base', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = '기본 방(블루)');

INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT 'SSAFY 캠퍼스', '캠퍼스 테마 배경', 700, 'BACKGROUND', '/backgrounds/base/bg_campus_basic.png', 'base', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = 'SSAFY 캠퍼스');

-- ========== BACKGROUND: stickers(스티커) ==========
INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT '몬스테라 화분', '공간에 생기를 더하는 화분 스티커', 200, 'BACKGROUND', '/backgrounds/stickers/plant_monstera.png', 'sticker', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = '몬스테라 화분');

INSERT INTO shop_items (name, description, price, type, image_url, category, is_active, created_at, updated_at)
SELECT '벽시계', '시간을 알려주는 벽 시계 스티커', 150, 'BACKGROUND', '/backgrounds/stickers/clock_wall.png', 'sticker', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM shop_items WHERE name = '벽시계');
```

### (선택) V3에 base 배경을 backgrounds 테이블에도 시드
- 목적: base 배경 구매 시 `user_backgrounds` 지급과 Mascot 배경 API 연계를 위해
- 방식: 위 V3 파일에 함께 포함하거나, 별도 V3b/V4 파일로 분리
- 초안 예시
```sql
INSERT INTO backgrounds (id, name, preview_url, enabled, created_at, updated_at)
SELECT 'bg_room_basic', '기본 방(블루)', '/backgrounds/base/bg_room_basic.png', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM backgrounds WHERE id = 'bg_room_basic');

INSERT INTO backgrounds (id, name, preview_url, enabled, created_at, updated_at)
SELECT 'bg_campus_basic', 'SSAFY 캠퍼스', '/backgrounds/base/bg_campus_basic.png', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM backgrounds WHERE id = 'bg_campus_basic');
```

## 검증 플로우
1) 로컬 부팅: `cd backend/solsol && ./gradlew bootRun` → Flyway V2/V3 적용 로그 확인(H2 파일 DB)
2) 목록 확인: `GET /api/v1/shop/items` → type/category/image_url/price 기대값 확인(기본은 owned=false)
3) 프론트 자산 확인: `frontend/public`에 대응 PNG 배치 시 이미지 렌더 정상
4) 구매 이후 꾸미기 화면: `MascotCustomize.vue`는 owned=true만 노출 → 구매 테스트로 보유 상태 확인(포인트 충분 필요)

## 주의 사항
- 기존 V1 스키마의 `image_url` 길이(255)는 엔티티(500)와 상이 → V2에서 500으로 통일
- 배경 base를 Mascot 배경으로도 쓰려면 backgrounds 시드 및 구매 시 지급 로직(서비스 계층) 확장 필요(차후 작업)
- 프론트 `ItemShop.vue`에서 background 선택 시 base/sticker 모두 포함하도록 필터 로직 점검 필요(차후 작업)

## 이후 작업(별 PR 권장)
- Service: BACKGROUND base 구매 시 `user_backgrounds` 지급(멱등 insert)
- FE: background 필터(‘배경’ 탭에서 base+sticker), 꾸미기 화면 배경 선택 UX 연결
- 운영 DB 반영 시 가격/구성 확정 및 이미지 자산 교체

---
작성일: 2025-08-26, 작성자: (자동화 에이전트)
