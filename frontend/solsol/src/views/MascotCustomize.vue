<template>
  <div class="min-h-screen bg-gradient-to-br from-purple-100 via-blue-100 to-green-100 flex items-center justify-center p-4">
    <!-- Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ï¶à Ïπ¥Îìú -->
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8">
      <!-- ÏÉÅÎã® Ìó§Îçî -->
      <div class="flex justify-between items-center mb-6">
        <!-- Ï¢åÏ∏°: Îí§Î°úÍ∞ÄÍ∏∞ + Ï†úÎ™© -->
        <div class="flex items-center space-x-3">
          <button 
            @click="goBack"
            class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors"
          >
            <img src="/icons/icon_back.png" alt="Îí§Î°úÍ∞ÄÍ∏∞" class="w-5 h-5" />
          </button>
          <h1 class="text-xl font-bold text-gray-800">Customize</h1>
        </div>
        
        <!-- Ïö∞Ï∏°: Ìè¨Ïù∏Ìä∏ -->
        <div class="flex items-center space-x-2">
          <img src="/icons/icon_point.png" alt="Ìè¨Ïù∏Ìä∏" class="w-5 h-5" />
          <span class="font-bold text-orange-600">{{ userCoins }}P</span>
        </div>
      </div>

      <!-- ÎßàÏä§ÏΩîÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏòÅÏó≠ -->
      <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl mb-6 w-full">
        <!-- Î∞∞Í≤Ω Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï UI -->
        <div v-if="showBgPanel" class="mb-4 bg-white bg-opacity-80 rounded-lg p-3 flex items-center gap-4">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-700">Î∞∞Í≤ΩÏÉâ</span>
            <input type="color" v-model="bgColor" class="w-8 h-8 rounded cursor-pointer border" />
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-700">Ìå®ÌÑ¥</span>
            <button 
              class="px-2 py-1 rounded text-xs border"
              :class="bgPattern === 'none' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700'"
              @click="bgPattern = 'none'">ÏóÜÏùå</button>
            <button 
              class="px-2 py-1 rounded text-xs border"
              :class="bgPattern === 'dots' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700'"
              @click="bgPattern = 'dots'">ÎèÑÌä∏</button>
            <button 
              class="px-2 py-1 rounded text-xs border"
              :class="bgPattern === 'stripes' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700'"
              @click="bgPattern = 'stripes'">Ïä§Ìä∏ÎùºÏù¥ÌîÑ</button>
          </div>
          <!-- Ï†ÄÏû• Î≤ÑÌäº Ï†úÍ±∞: Î©îÏù∏ Ï†ÄÏû•Ïóê ÌÜµÌï©Îê® -->
        </div>
        <!-- Î™®Î∞îÏùº ÎèÑÏõÄÎßê Ï†úÍ±∞ -->
        
        <div 
          class="relative w-full h-80 rounded-xl overflow-hidden flex items-center justify-center"
          :style="previewBackgroundStyle"
        >
          <!-- Î∞∞Í≤Ω Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï ÌÜ†Í∏Ä ÏïÑÏù¥ÏΩò (Ï¢åÌïòÎã®) -->
          <button
            class="absolute bottom-2 left-2 z-50 w-9 h-9 rounded-full shadow bg-white/90 hover:bg-white flex items-center justify-center border border-gray-200 pointer-events-auto"
            title="Î∞∞Í≤Ω Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï"
            @click.stop="toggleBgPanel"
          >
            <!-- ÌåîÎ†àÌä∏ ÏïÑÏù¥ÏΩò -->
            <span class="text-lg">üé®</span>
          </button>
          <!-- Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ï¶à Î∞∞Í≤Ω -->
          <!--08.27 ÏûÑÏãú ÏÇ≠Ï†ú ÏΩîÎìú by ÎØºÏ†ï-->
          <!-- <img 
            src="/backgrounds/base/bg_blue.png" 
            alt="Íæ∏ÎØ∏Í∏∞ Î∞∞Í≤Ω" 
            class="absolute inset-0 w-full h-full object-cover"
          />
           -->
          <!-- ÎßàÏä§ÏΩîÌä∏ + Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÎì§ -->
          <div 
            ref="mascotCanvas"
            class="mascot-canvas absolute inset-0 flex items-center justify-center"
            @click="handleCanvasClick"
          >
            <!-- Ï§ëÏïô Í≥†Ï†ï ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ -->
            <div 
              ref="mascotRef"
              class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 z-10"
            >
              <img 
                :src="currentMascot ? getMascotImageUrl(currentMascot.type) : '/mascot/soll.png'" 
                :alt="currentMascot?.name || 'ÎßàÏä§ÏΩîÌä∏'" 
                class="w-full h-full object-contain drop-shadow-lg"
                @load="handleMascotImageLoad"
                @error="handleMascotImageError"
              />
            </div>
            
            <!-- Î†àÏù¥Ïñ¥ 1: Î∞∞Í≤Ω ÏïÑÏù¥ÌÖú (ÎßàÏä§ÏΩîÌä∏ Îí§, Ï∫îÎ≤ÑÏä§ Ï†ÑÏ≤¥ Ï±ÑÏõÄ) -->
            <div class="absolute inset-0 z-0 overflow-hidden">
              <img
                v-for="bg in backgroundEquippedItems"
                :key="bg.id"
                :src="bg.item.imageUrl"
                :alt="bg.item.name"
                class="absolute inset-0 w-full h-full object-cover pointer-events-none"
              />
            </div>

            <!-- Î†àÏù¥Ïñ¥ 2: ÎßàÏä§ÏΩîÌä∏ (Ï§ëÍ∞Ñ) -->
            <!-- Ïù¥ÎØ∏ ÏúÑÏóêÏÑú ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄÎ•º Î†åÎçîÎßÅ Ï§ëÏù¥ÎØÄÎ°ú Ïù¥ Î∏îÎ°ùÏùÄ Ïú†ÏßÄ -->

            <!-- Î†àÏù¥Ïñ¥ 3: Ï†ÑÍ≤Ω ÏïÑÏù¥ÌÖú (ÎßàÏä§ÏΩîÌä∏ Ïïû) -->
            <div class="absolute inset-0 z-20" ref="foregroundLayer">
              <DraggableItem
                v-for="fg in foregroundEquippedItems"
                :key="fg.id"
                :item="fg.item"
                :position="getAbsolutePosition(fg)"
                :scale="fg.scale"
                :rotation="fg.rotation"
                :is-selected="selectedItemId === fg.id"
                :container-bounds="foregroundBounds || canvasBounds"
                @update:position="updateItemPosition(fg.id, $event)"
                @update:scale="updateItemScale(fg.id, $event)"
                @update:rotation="updateItemRotation(fg.id, $event)"
                @select="selectItem(fg.id)"
              />
            </div>
          </div>
          
          <!-- ÎßàÏä§ÏΩîÌä∏ Ïù¥Î¶Ñ -->
          <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
            <div class="bg-white bg-opacity-90 px-3 py-1 rounded-full">
              <span class="text-sm font-medium text-gray-800">{{ currentMascot?.name || 'Ïè†' }}</span>
            </div>
          </div>
          
          <!-- ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥ (Î™®Î∞îÏùº) -->
          <div 
            v-if="isMobileDevice && selectedItemInfo"
            class="absolute top-2 right-2 bg-white bg-opacity-95 p-2 rounded-lg shadow-lg text-xs max-w-32"
          >
            <div class="font-medium text-gray-800 mb-1">{{ selectedItemInfo.name }}</div>
            <div class="text-gray-600 space-y-1">
              <div>ÏúÑÏπò: {{ Math.round(selectedItemInfo.relativePosition.x * 100) }}%, {{ Math.round(selectedItemInfo.relativePosition.y * 100) }}%</div>
              <div>ÌÅ¨Í∏∞: {{ Math.round(selectedItemInfo.scale * 100) }}%</div>
              <div>ÌöåÏ†Ñ: {{ Math.round(selectedItemInfo.rotation) }}¬∞</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ÎßàÏä§ÏΩîÌä∏ Ï°∞Ïûë Ìå®ÎÑê Ï†úÍ±∞Îê® (ÎßàÏä§ÏΩîÌä∏Îäî Ï§ëÏïôÏóê Í≥†Ï†ï) -->
      
      
      
      <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠Îì§ -->
      <div class="mb-6">
        <div class="flex space-x-2 overflow-x-auto">
          <button 
            v-for="category in itemCategories" 
            :key="category.id"
            @click="selectedCategory = category.id as 'head' | 'clothing' | 'accessory' | 'background'"
            :class="[
              'flex-shrink-0 flex flex-col items-center p-3 rounded-xl transition-all min-w-[80px]',
              selectedCategory === category.id 
                ? 'bg-purple-500 text-white shadow-lg' 
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            ]"
          >
            <div class="w-10 h-10 rounded-full flex items-center justify-center mb-2" 
                 :class="selectedCategory === category.id ? 'bg-white bg-opacity-20' : 'bg-white'">
              <span class="text-xl">{{ category.icon }}</span>
            </div>
            <span class="text-xs font-medium">{{ category.name }}</span>
          </button>
        </div>
      </div>
      
      <!-- ÏïÑÏù¥ÌÖú Î™©Î°ù -->
      <div class="space-y-4">
        <h3 class="text-lg font-bold text-gray-800">{{ getCategoryName(selectedCategory) }}</h3>
        
        <div class="grid grid-cols-2 gap-4">
          <div 
            v-for="item in filteredItems" 
            :key="item.id"
            :class="[
              'relative border-2 rounded-xl p-4 transition-all',
              isEquipped(item) 
                ? 'border-purple-500 bg-purple-50' 
                : 'border-gray-200 hover:border-gray-300',
              canEquipMoreItems || isEquipped(item)
                ? 'cursor-pointer hover:shadow-md'
                : 'cursor-not-allowed opacity-60'
            ]"
            @click="handleItemClick(item)"
          >
            <!-- ÏïÑÏù¥ÌÖú Ïù¥ÎØ∏ÏßÄ -->
            <div class="w-full h-20 bg-gray-100 rounded-lg mb-3 flex items-center justify-center overflow-hidden">
              <img 
                :src="item.imageUrl" 
                :alt="item.name"
                class="w-full h-full object-contain"
                @error="handleImageError"
              />
            </div>
            
            <!-- ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥ -->
            <div>
              <h4 class="font-medium text-sm text-gray-800 mb-1 flex items-center">
                {{ item.name }}
                <span v-if="isEquipped(item)" class="text-purple-600 text-xs ml-1">
                  ‚úì{{ getEquippedCount(item) > 1 ? ` (${getEquippedCount(item)})` : '' }}
                </span>
              </h4>
              <p class="text-xs text-gray-600 mb-2 line-clamp-2">{{ item.description }}</p>
              
              <!-- Ï∞©Ïö© ÏÉÅÌÉú ÌëúÏãú -->
              <div class="text-center">
                <span 
                  :class="[
                    'text-xs font-medium px-3 py-1 rounded-full',
                    isEquipped(item) 
                      ? 'bg-purple-500 text-white' 
                      : canEquipMoreItems 
                        ? 'bg-gray-200 text-gray-600' 
                        : 'bg-red-100 text-red-600'
                  ]"
                >
                  {{ isEquipped(item) 
                    ? `Ï∞©Ïö©Ï§ë (${getEquippedCount(item)})` 
                    : canEquipMoreItems
                      ? 'Ï∞©Ïö©ÌïòÍ∏∞' 
                      : 'Ïû•Ï∞© Î∂àÍ∞Ä' }}
                </span>
              </div>
            </div>

            <!-- Ïû•Ï∞© ÏïÑÏù¥ÏΩò -->
            <div 
              v-if="isEquipped(item)"
              class="absolute top-2 right-2 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center"
            >
              <span class="text-white text-xs">‚úì</span>
            </div>
          </div>
        </div>
        
        <!-- ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÎäî Í≤ΩÏö∞ -->
        <div v-if="filteredItems.length === 0" class="text-center py-8">
          <div class="text-4xl mb-2 opacity-50">üì¶</div>
          <p class="text-gray-500">Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>
        </div>
      </div>
      
      <!-- Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖú Î™©Î°ù -->
      <div v-if="equippedItemsList.length > 0" class="mb-6">
        <h3 :class="[
          'text-lg font-bold mb-3 flex items-center space-x-2',
          equippedItemsList.length >= maxEquippedItems ? 'text-red-600' : 'text-gray-800'
        ]">
          <span>Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖú ({{ equippedItemsList.length }}/{{ maxEquippedItems }})</span>
          <span v-if="equippedItemsList.length >= maxEquippedItems" class="text-red-500 text-sm">‚ö†Ô∏è ÏµúÎåÄ</span>
        </h3>
        
        <div class="space-y-2 max-h-32 overflow-y-auto">
          <div 
            v-for="equippedItem in equippedItemsList" 
            :key="equippedItem.id"
            :class="[
              'flex items-center justify-between p-2 rounded-lg border transition-all cursor-pointer',
              selectedItemId === equippedItem.id 
                ? 'border-blue-400 bg-blue-50' 
                : 'border-gray-200 bg-white hover:border-gray-300'
            ]"
            @click="selectItem(equippedItem.id)"
          >
            <div class="flex items-center space-x-2">
              <img 
                :src="equippedItem.item.imageUrl" 
                :alt="equippedItem.item.name"
                class="w-8 h-8 object-contain bg-gray-100 rounded"
                @error="handleImageError"
              />
              <div>
                <div class="text-sm font-medium text-gray-800">{{ equippedItem.item.name }}</div>
                <div class="text-xs text-gray-500">
                  {{ Math.round(equippedItem.scale * 100) }}% | {{ Math.round(equippedItem.rotation) }}¬∞
                </div>
              </div>
            </div>
            
            <button 
              @click.stop="removeEquippedItem(equippedItem.id)"
              class="w-6 h-6 bg-red-100 hover:bg-red-200 text-red-600 rounded-full flex items-center justify-center text-xs transition-colors"
              title="ÏïÑÏù¥ÌÖú Ï†úÍ±∞"
            >
              √ó
            </button>
          </div>
        </div>
      </div>
      
      <!-- Ï†ÑÏ≤¥ Ï°∞Ïûë Î≤ÑÌäºÎì§ -->
      <div class="flex space-x-3 mt-6">
        <button 
          @click="resetAllItems"
          class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2"
        >
          <span>üîÑ</span>
          <span>Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</span>
        </button>
        <button 
          @click="saveItemPositions"
          class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2"
        >
          <span>üíæ</span>
          <span>Ï†ÄÏû•ÌïòÍ∏∞</span>
        </button>
      </div>
    </div>
    
    <!-- ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ -->
    <div 
      v-if="showToast" 
      class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all"
    >
      {{ toastMessage }}
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, nextTick, onMounted, onUnmounted, onActivated, ref } from 'vue';
import { useRouter } from 'vue-router';
import { getMascot, getMascotCustomization, getShopItems, handleApiError, saveMascotCustomization, updateMascotBackground } from '../api/index';
import DraggableItem from '../components/DraggableItem.vue';
import { mascotTypes } from '../data/mockData';
import type { Item, Mascot } from '../types/api';
import {
  constrainMascotRelativePositionLoose,
  getContainerSize,
  getDefaultMascotRelativePosition,
  toAbsoluteFromMascot,
  toRelativeToMascot,
  type RelativePosition
} from '../utils/coordinates';

// ÏïÑÏù¥ÌÖú ÏÉÅÌÉú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ (Îã§Ï§ë ÏïÑÏù¥ÌÖú ÏßÄÏõê)
interface EquippedItemState {
  id: string; // Í≥†Ïú† ID (item.id + Ïû•Ï∞© ÏàúÏÑú)
  item: Item;
  relativePosition: RelativePosition; // ÏÉÅÎåÄ Ï¢åÌëú (0~1 ÎπÑÏú®)
  scale: number;
  rotation: number; // ÌöåÏ†Ñ Í∞ÅÎèÑ (degrees)
  equippedAt: number; // Ïû•Ï∞© ÏãúÍ∞Ñ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)
}

// ÎßàÏä§ÏΩîÌä∏ Í∏∞Î∞ò Ï¢åÌëúÍ≥Ñ ÏôÑÏÑ± - Î™®Îì† ÏïÑÏù¥ÌÖúÏù¥ ÎßàÏä§ÏΩîÌä∏Î•º Í∏∞Ï§ÄÏúºÎ°ú Î∞∞ÏπòÎê®

const router = useRouter();

// Î∞òÏùëÌòï Îç∞Ïù¥ÌÑ∞
const currentMascot = ref<Mascot | null>(null);
const items = ref<any[]>([]);
const userCoins = ref(15000);
const selectedCategory = ref<'head' | 'clothing' | 'accessory' | 'background'>('head');

// ÎìúÎûòÍ∑∏ Í¥ÄÎ†® ÏÉÅÌÉú
const mascotCanvas = ref<HTMLElement>();
const canvasBounds = ref<DOMRect | null>(null);
const foregroundLayer = ref<HTMLElement>();
const foregroundBounds = ref<DOMRect | null>(null);
const selectedItemId = ref<string | null>(null); // Í≥†Ïú† IDÎ°ú Î≥ÄÍ≤Ω
const equippedItemStates = ref<Map<string, EquippedItemState>>(new Map()); // Îã§Ï§ë ÏïÑÏù¥ÌÖú ÏßÄÏõê
const isMobileDevice = ref(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));

// Îã§Ï§ë ÏïÑÏù¥ÌÖú Í¥ÄÎ¶¨
const equippedItemsList = ref<EquippedItemState[]>([]); // Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖú Î™©Î°ù
const maxEquippedItems = 10; // ÏµúÎåÄ Ïû•Ï∞© Í∞ÄÎä• ÏïÑÏù¥ÌÖú Ïàò

// ÎßàÏä§ÏΩîÌä∏Îäî Ï§ëÏïôÏóê Í≥†Ï†ï (ÎìúÎûòÍ∑∏ Î∂àÍ∞Ä)
const mascotRef = ref<HTMLElement>();
const mascotRect = ref<DOMRect | null>(null);

// ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º
const showToast = ref(false);
const toastMessage = ref('');
const showBgPanel = ref(false);

// Î∞∞Í≤Ω Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï ÏÉÅÌÉú
const bgColor = ref<string>('#ffffff');
const bgPattern = ref<'dots' | 'stripes' | 'none'>('none');

const previewBackgroundStyle = computed(() => {
  const style: Record<string, string> = {
    backgroundColor: bgColor.value || '#ffffff',
  };
  if (bgPattern.value === 'dots') {
    style.backgroundImage = 'radial-gradient(circle, rgba(0,0,0,0.12) 1px, transparent 1px)';
    style.backgroundSize = '12px 12px';
  } else if (bgPattern.value === 'stripes') {
    style.backgroundImage = 'repeating-linear-gradient(45deg, rgba(0,0,0,0.08) 0 10px, transparent 10px 20px)';
  } else {
    style.backgroundImage = 'none';
  }
  return style;
});

// ÌëúÏ§ÄÌôî Ïú†Ìã∏: ÏÑúÎ≤ÑÏóêÏÑú Ïò§Îäî ÌÉÄÏûÖ/Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÎåÄÏÜåÎ¨∏Ïûê ÌòºÎèôÏùÑ Î∞©ÏßÄ
function normalizeType(val: unknown): string {
  return (val ?? '').toString().toLowerCase();
}

async function saveBackground() {
  try {
    await updateMascotBackground({ backgroundColor: bgColor.value, patternType: bgPattern.value });
    showToastMessage('Î∞∞Í≤Ω ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
  } catch (e) {
    const msg = handleApiError(e);
    showToastMessage(`Î∞∞Í≤Ω Ï†ÄÏû• Ïã§Ìå®: ${msg}`);
  }
}

function toggleBgPanel() {
  showBgPanel.value = !showBgPanel.value;
}

// ÏïÑÏù¥ÌÖú Ïπ¥ÌÖåÍ≥†Î¶¨
const itemCategories = [
  { id: 'head', name: 'Head', icon: 'üëï' },
  { id: 'clothing', name: 'Clothing', icon: 'üëñ' },
  { id: 'accessory', name: 'Accessory', icon: 'üëì' },
  { id: 'background', name: 'Background', icon: 'üñºÔ∏è' }
];

// Î≤ÑÌäº Ìå®ÎÑê Ï†úÍ±∞: ÎìúÎûòÍ∑∏/ÌïÄÏπò/ÌöåÏ†Ñ Ï†úÏä§Ï≤òÎßå Ï†úÍ≥µ

// ÌïÑÌÑ∞ÎßÅÎêú ÏïÑÏù¥ÌÖú Î™©Î°ù (Î≥¥Ïú†Ìïú ÏïÑÏù¥ÌÖúÎßå)
// ShopController.getItemsWithOwnership ‚Üí ItemResponse(category, owned) Í∏∞Ï§ÄÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
const filteredItems = computed(() => {
  const target = selectedCategory.value; // 'head' | 'clothing' | 'accessory' | 'background'
  return items.value.filter((item: any) => {
    const cat = normalizeType(item.category);
    const typ = normalizeType(item.type); // EQUIP/BACKGROUND Îì±
    const isOwned = item.owned === true || item.isOwned === true;
    if (!isOwned) return false;
    if (target === 'background') {
      // ÏùºÎ∂Ä ÏùëÎãµÏù¥ category ÎåÄÏã† typeÏúºÎ°ú BACKGROUNDÎßå ÎÇ¥Î†§Ïò§Îäî Í≤ΩÏö∞ÎèÑ ÌóàÏö©
      return cat === 'background' || typ === 'background';
    }
    return cat === target;
  });
});

// Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÎì§Ïùò ÏÉÅÌÉú Î™©Î°ù (Îã§Ï§ë ÏïÑÏù¥ÌÖú ÏßÄÏõê)
const equippedItems = computed(() => {
  // ÏÉàÎ°úÏö¥ Îã§Ï§ë ÏïÑÏù¥ÌÖú ÏãúÏä§ÌÖúÏóêÏÑúÎäî equippedItemsListÎ•º ÏßÅÏ†ë ÏÇ¨Ïö©
  return equippedItemsList.value;
});

// Î∞∞Í≤Ω ÏïÑÏù¥ÌÖú/Ï†ÑÍ≤Ω ÏïÑÏù¥ÌÖú Î∂ÑÎ¶¨ (Î†àÏù¥Ïñ¥ÎßÅ Ï†úÏñ¥)
const backgroundEquippedItems = computed(() =>
  equippedItemsList.value.filter(e => normalizeType(e.item?.type) === 'background')
);
const foregroundEquippedItems = computed(() =>
  equippedItemsList.value.filter(e => normalizeType(e.item?.type) !== 'background')
);

// Îçî ÎßéÏùÄ ÏïÑÏù¥ÌÖúÏùÑ Ïû•Ï∞©Ìï† Ïàò ÏûàÎäîÏßÄ ÌôïÏù∏
const canEquipMoreItems = computed(() => {
  return equippedItemsList.value.length < maxEquippedItems;
});

// ÎßàÏä§ÏΩîÌä∏Îäî CSSÎ°ú Ï§ëÏïôÏóê Í≥†Ï†ïÎê®

// Í∏∞Ï°¥ ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏïÑÏù¥ÌÖú Î°úÎìú (Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï®)
function loadEquippedItemsFromMascot() {
  if (!currentMascot.value?.equippedItem) return;
  
  console.log('ÎßàÏä§ÏΩîÌä∏ÏóêÏÑú Ïû•Ï∞© ÏïÑÏù¥ÌÖú Î°úÎìú:', currentMascot.value.equippedItem);
  
  // Í∏∞Ï°¥ Îã®Ïùº ÏïÑÏù¥ÌÖú ÏãúÏä§ÌÖúÍ≥ºÏùò Ìò∏ÌôòÏÑ±
  ['head', 'clothing', 'accessory', 'background'].forEach(type => {
    const item = items.value.find(item => 
      item.type === type && 
      currentMascot.value!.equippedItem!.includes(item.name)
    );
    
    if (item) {
      // Ïù¥ÎØ∏ Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÏù∏ÏßÄ ÌôïÏù∏
      const existingItem = equippedItemsList.value.find(equipped => 
        equipped.item.id === item.id
      );
      
      if (!existingItem) {
        // addEquippedItem ÎåÄÏã† ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÏó¨ Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ
        const id = generateItemId(item);
        const newEquippedItem: EquippedItemState = {
          id,
          item,
          relativePosition: getDefaultPosition(item.type),
          scale: 1,
          rotation: 0,
          equippedAt: Date.now(),
        };
        
        equippedItemsList.value.push(newEquippedItem);
        equippedItemStates.value.set(id, newEquippedItem);
        
        console.log(`ÎßàÏä§ÏΩîÌä∏ÏóêÏÑú ÏïÑÏù¥ÌÖú Î°úÎìú: ${item.name}`);
      }
    }
  });
}

// ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖúÏùò Ï†ïÎ≥¥
const selectedItemInfo = computed(() => {
  if (!selectedItemId.value) return null;
  
  const state = equippedItemStates.value.get(selectedItemId.value);
  if (!state) return null;
  
  return {
    name: state.item.name,
    relativePosition: state.relativePosition,
    scale: state.scale,
    rotation: state.rotation,
  };
});

// ÏÇ¨Ïö©Ïûê Î≥¥Ïú† ÏïÑÏù¥ÌÖú Î°úÎìú
async function loadUserItems() {
  try {
    const shopItems = await getShopItems();
    items.value = shopItems;
    console.log('ÏÇ¨Ïö©Ïûê Î≥¥Ïú† ÏïÑÏù¥ÌÖú Î°úÎìúÎê®:', shopItems);
  } catch (error) {
    console.error('ÏïÑÏù¥ÌÖú Î°úÎìú Ïã§Ìå®:', error);
    showToastMessage('ÏïÑÏù¥ÌÖú Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
  }
}

// Ïä§ÎÉÖÏÉ∑ Ìï©ÏÑ±: Î∞∞Í≤Ω ‚Üí ÎßàÏä§ÏΩîÌä∏ ‚Üí ÏïÑÏù¥ÌÖú(ÏúÑÏπò/Ïä§ÏºÄÏùº/ÌöåÏ†Ñ)
async function composeSnapshotDataUrl(): Promise<string> {
  const DPR = Math.max(1, Math.min(3, Math.floor(window.devicePixelRatio || 1)));
  const canvasSize = 800;
  const canvas = document.createElement('canvas');
  canvas.width = canvasSize * DPR;
  canvas.height = canvasSize * DPR;
  const ctx = canvas.getContext('2d');
  if (!ctx) return '';
  ctx.scale(DPR, DPR);
  ctx.imageSmoothingEnabled = true;

  const loadImage = (src: string) => new Promise<HTMLImageElement>((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });

  // Î∞∞Í≤Ω
  const bgImg = await loadImage('/backgrounds/base/bg_blue.png');
  ctx.drawImage(bgImg, 0, 0, canvasSize, canvasSize);

  // ÎßàÏä§ÏΩîÌä∏
  const mascotUrl = currentMascot.value ? getMascotImageUrl(currentMascot.value.type) : '/mascot/soll.png';
  const mascotImg = await loadImage(mascotUrl);
  const mascotBoxSize = Math.floor(canvasSize * 0.5); // Ï§ëÏïô 50%
  const mascotX = (canvasSize - mascotBoxSize) / 2;
  const mascotY = (canvasSize - mascotBoxSize) / 2;
  ctx.drawImage(mascotImg, mascotX, mascotY, mascotBoxSize, mascotBoxSize);

  // ÏïÑÏù¥ÌÖúÎì§
  const UI_MASCOT_PX = 128;
  const baseItemSize = (120 /* BASE_ITEM_SIZE */ / UI_MASCOT_PX) * mascotBoxSize;
  for (const e of equippedItemsList.value) {
    try {
      const img = await loadImage(e.item.imageUrl || '');
      const centerX = mascotX + (e.relativePosition.x * mascotBoxSize);
      const centerY = mascotY + (e.relativePosition.y * mascotBoxSize);
      const size = Math.max(12, baseItemSize * (e.scale ?? 1));
      const rot = (((e.rotation ?? 0) % 360) + 360) % 360;
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate((rot * Math.PI) / 180);
      ctx.drawImage(img, -size / 2, -size / 2, size, size);
      ctx.restore();
    } catch {}
  }

  // Data URL Î∞òÌôò (Ïö©ÎüâÏùÑ ÏúÑÌï¥ Í∏∞Î≥∏ PNG)
  try {
    return canvas.toDataURL('image/png');
  } catch {
    return '';
  }
}

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
// ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ URL Ï∫êÏãú (Î¶¨Î†åÎçîÎßÅ ÏµúÏ†ÅÌôî)
const mascotImageUrlCache = new Map<string, string>();

function getMascotImageUrl(type: string): string {
  // Ï∫êÏãúÏóêÏÑú ÌôïÏù∏
  if (mascotImageUrlCache.has(type)) {
    return mascotImageUrlCache.get(type)!;
  }
  
  console.log('üñºÔ∏è ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ URL Í≥ÑÏÇ∞:', { type });
  const typeObj = mascotTypes.find(t => t.id === type);
  const imageUrl = typeObj ? typeObj.imageUrl : '/mascot/soll.png';
  
  // Ï∫êÏãúÏóê Ï†ÄÏû•
  mascotImageUrlCache.set(type, imageUrl);
  console.log('‚úÖ ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ URL Ï∫êÏãúÎê®:', imageUrl);
  
  return imageUrl;
}

function getCategoryName(category: 'head' | 'clothing' | 'accessory' | 'background'): string {
  const categoryMap: Record<string, string> = {
    head: 'Î®∏Î¶¨',
    clothing: 'ÏùòÏÉÅ', 
    accessory: 'Ïï°ÏÑ∏ÏÑúÎ¶¨',
    background: 'Î∞∞Í≤Ω'
  };
  return categoryMap[category] || category;
}

// ÏïÑÏù¥ÌÖú ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏ ÏÉÅÎåÄ ÏúÑÏπò ÏÑ§Ï†ï
function getDefaultPosition(itemType: string): RelativePosition {
  return getDefaultMascotRelativePosition(itemType);
}

// Îã§Ï§ë ÏïÑÏù¥ÌÖú Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
function generateItemId(item: Item): string {
  return `${item.id}_${Date.now()}`;
}

function addEquippedItem(item: Item): boolean {
  // ÏµúÎåÄ Í∞úÏàò Ï≤¥ÌÅ¨
  if (equippedItemsList.value.length >= maxEquippedItems) {
    showToastMessage(`ÏµúÎåÄ ${maxEquippedItems}Í∞úÍπåÏßÄÎßå Ïû•Ï∞©Ìï† Ïàò ÏûàÏäµÎãàÎã§!`);
    return false;
  }
  
  const id = generateItemId(item);
  const newEquippedItem: EquippedItemState = {
    id,
    item,
    // ÏÉà ÏïÑÏù¥ÌÖúÏùÄ ÎßàÏä§ÏΩîÌä∏ Ï§ëÏïôÏóê ÏûêÎèô Î∞∞Ïπò
    relativePosition: { x: 0.5, y: 0.5 },
    scale: 1,
    rotation: 0,
    equippedAt: Date.now(),
  };
  
  equippedItemsList.value.push(newEquippedItem);
  equippedItemStates.value.set(id, newEquippedItem);
  
  // currentMascot.equippedItem ÌïÑÎìú ÎèôÍ∏∞Ìôî
  updateMascotEquippedItems();
  
  showToastMessage(`${item.name}ÏùÑ(Î•º) Ïû•Ï∞©ÌñàÏäµÎãàÎã§!`);
  return true;
}

function removeEquippedItem(itemId: string): boolean {
  const index = equippedItemsList.value.findIndex(item => item.id === itemId);
  if (index === -1) return false;
  
  const removedItem = equippedItemsList.value[index];
  equippedItemsList.value.splice(index, 1);
  equippedItemStates.value.delete(itemId);
  
  // ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖúÏù¥ Ï†úÍ±∞ÎêòÎ©¥ ÏÑ†ÌÉù Ìï¥Ï†ú
  if (selectedItemId.value === itemId) {
    selectedItemId.value = null;
  }
  
  // currentMascot.equippedItem ÌïÑÎìú ÎèôÍ∏∞Ìôî
  updateMascotEquippedItems();
  
  showToastMessage(`${removedItem.item.name}ÏùÑ(Î•º) Ìï¥Ï†úÌñàÏäµÎãàÎã§!`);
  return true;
}

function isItemEquipped(item: Item): boolean {
  return equippedItemsList.value.some(equipped => equipped.item.id === item.id);
}

function getEquippedCount(item: Item): number {
  return equippedItemsList.value.filter(equipped => equipped.item.id === item.id).length;
}

// currentMascot.equippedItem ÌïÑÎìúÎ•º ÌòÑÏû¨ Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÎì§Í≥º ÎèôÍ∏∞Ìôî
function updateMascotEquippedItems() {
  if (!currentMascot.value) return;
  
  // Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÎì§Ïùò Ïù¥Î¶ÑÏùÑ ÏàòÏßë (Ï§ëÎ≥µ Ï†úÍ±∞)
  const equippedItemNames = [...new Set(
    equippedItemsList.value.map(equipped => equipped.item.name)
  )];
  
  // Î¨∏ÏûêÏó¥Î°ú Ïó∞Í≤∞ (Í∏∞Ï°¥ Î∞©ÏãùÍ≥º Ìò∏Ìôò)
  currentMascot.value.equippedItem = equippedItemNames.join(',');
  
  console.log('ÎßàÏä§ÏΩîÌä∏ Ïû•Ï∞© ÏïÑÏù¥ÌÖú ÎèôÍ∏∞Ìôî:', {
    equippedItems: equippedItemsList.value.map(e => e.item.name),
    equippedItemString: currentMascot.value.equippedItem
  });
}

// ÏïàÏ†ïÏ†ÅÏù∏ Ï∫îÎ≤ÑÏä§ bounding box Ï∫êÏãú
let stableCanvasRect: DOMRect | null = null;
let lastCanvasUpdateTime = 0;
// Î†àÏù¥ÏïÑÏõÉ Ïä§ÎÉÖÏÉ∑(Í∞ôÏùÄ ÌîÑÎ†àÏûÑÏùò canvas/mascot rect ÎèôÏãú Ï∏°Ï†ï)
const layoutSnapshot = ref<{ canvasRect: DOMRect; mascotRect: DOMRect; ts: number } | null>(null);

function captureLayoutSnapshot(immediate = false) {
  const doCapture = () => {
    if (!mascotCanvas.value || !mascotRef.value) return;
    const c = mascotCanvas.value.getBoundingClientRect();
    const m = mascotRef.value.getBoundingClientRect();
    layoutSnapshot.value = { canvasRect: c, mascotRect: m, ts: performance.now() };
    stableCanvasRect = c;
    lastCanvasUpdateTime = Date.now();
  };
  if (immediate) doCapture(); else requestAnimationFrame(doCapture);
}

// ÏúÑÏπò Í≥ÑÏÇ∞ Í≤∞Í≥º Ï∫êÏãú (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
const positionCache = new Map<string, { x: number; y: number; timestamp: number }>();
const POSITION_CACHE_DURATION = 250; // 250ms Ï∫êÏãúÎ°ú ÎØ∏ÏÑ∏Ìïú Î†àÏù¥ÏïÑÏõÉ Î≥ÄÎèô Ìù°Ïàò

// Ï†ÄÏû• Ï§ë Î†åÎçî ÏïàÏ†ïÌôîÎ•º ÏúÑÌïú ÏµúÏ¢Ö Î†åÎçî Ï¢åÌëú Ï∫êÏãú(ÏïÑÏù¥ÌÖúÎ≥Ñ)
const lastRenderedPosition = new Map<string, { x: number; y: number }>();
const isSaving = ref(false);
const BASE_ITEM_SIZE = 120; // DraggableItemÏùò Í∏∞Î≥∏ ÏÇ¨Ïù¥Ï¶àÏôÄ ÏùºÏπòÏãúÌÇ¥

// ÎßàÏä§ÏΩîÌä∏ Í∏∞Ï§Ä ÏÉÅÎåÄ Ï¢åÌëúÎ•º Ï†àÎåÄ Ï¢åÌëúÎ°ú Î≥ÄÌôòÌïòÏó¨ Î∞òÌôò
function getAbsolutePosition(equippedItem: EquippedItemState): { x: number; y: number } {
  if (!mascotRect.value || !mascotCanvas.value || mascotRect.value.width <= 0 || mascotRect.value.height <= 0) {
    // Ï†ÄÏû• Ï§ëÏóêÎäî ÎßàÏßÄÎßâ Î†åÎçî Ï¢åÌëúÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©ÌïòÏó¨ Ìäê Î∞©ÏßÄ
    if (isSaving.value) {
      const last = lastRenderedPosition.get(equippedItem.id);
      if (last) return last;
    }
    // ÏïàÏ†ÑÌïú Ìè¥Î∞±: Ï∫îÎ≤ÑÏä§ Ï§ëÏã¨Ïóê ÏïÑÏù¥ÌÖú(Ïä§ÏºÄÏùº Î∞òÏòÅ) Î∞∞Ïπò
    const canvasRect = mascotCanvas.value?.getBoundingClientRect();
    if (canvasRect) {
      const itemSize = BASE_ITEM_SIZE * (equippedItem.scale || 1);
      const x = (canvasRect.width - itemSize) / 2;
      const y = (canvasRect.height - itemSize) / 2;
      return { x, y };
    }
    console.warn('‚ö†Ô∏è ÎßàÏä§ÏΩîÌä∏/Ï∫îÎ≤ÑÏä§ Ï¢åÌëú ÎØ∏Í∞ÄÏö©: Ï¢åÏÉÅÎã®(0,0) Ìè¥Î∞±');
    return { x: 0, y: 0 };
  }
  
  // ÏúÑÏπò Í≥ÑÏÇ∞ Í≤∞Í≥º Ï∫êÏãú ÌôïÏù∏ (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
  const cacheKey = `${equippedItem.id}_${equippedItem.relativePosition.x}_${equippedItem.relativePosition.y}_${equippedItem.scale}`;
  const now = Date.now();
  const cachedPosition = positionCache.get(cacheKey);
  
  if (cachedPosition && (now - cachedPosition.timestamp < POSITION_CACHE_DURATION)) {
    return { x: cachedPosition.x, y: cachedPosition.y };
  }
  
  // Ï∫îÎ≤ÑÏä§ ÏúÑÏπòÎ•º ÏïàÏ†ïÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞ (Ï∫êÏãú ÏÇ¨Ïö©)
  const shouldUpdateCache = !stableCanvasRect || (now - lastCanvasUpdateTime > 300); // 300ms Ï∫êÏãú (Îçî Í∏¥ Ï∫êÏãú)
  
  if (shouldUpdateCache) {
    const newCanvasRect = mascotCanvas.value.getBoundingClientRect();
    
    // Ïã§Ï†úÎ°ú ÏúÑÏπòÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÎäîÏßÄ ÌôïÏù∏ (Î∂àÌïÑÏöîÌïú ÏóÖÎç∞Ïù¥Ìä∏ Î∞©ÏßÄ)
    // 5px Ïù¥ÏÉÅÏùò ÏùòÎØ∏ÏûàÎäî Î≥ÄÌôîÎßå Í∞êÏßÄ (ÏÑ†ÌÉù Ìå®ÎÑê fixed positioningÏúºÎ°ú Îçî ÏïàÏ†ï)
    const hasSignificantChange = !stableCanvasRect || 
      Math.abs(newCanvasRect.x - stableCanvasRect.x) > 5 ||
      Math.abs(newCanvasRect.y - stableCanvasRect.y) > 5 ||
      Math.abs(newCanvasRect.width - stableCanvasRect.width) > 5 ||
      Math.abs(newCanvasRect.height - stableCanvasRect.height) > 5;
    
    if (hasSignificantChange) {
      stableCanvasRect = newCanvasRect;
      lastCanvasUpdateTime = now;
      console.log('üìç Ï∫îÎ≤ÑÏä§ ÏúÑÏπò Ïã§Ï†ú Î≥ÄÍ≤ΩÏúºÎ°ú Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏:', stableCanvasRect);
    }
  }
  
  // ÎßàÏä§ÏΩîÌä∏Î•º Í∏∞Ï§ÄÏúºÎ°ú Ìïú Î∏åÎùºÏö∞Ï†Ä Ï†ÑÏ≤¥ ÌôîÎ©¥ Ï†àÎåÄ Ï¢åÌëú Í≥ÑÏÇ∞
  // ÎßàÏä§ÏΩîÌä∏ Í∏∞Ï§Ä ÏÉÅÎåÄÏ¢åÌëúÎ°úÎ∂ÄÌÑ∞ Î∏åÎùºÏö∞Ï†Ä Ï†àÎåÄ Ï¢åÌëú(ÏïÑÏù¥ÌÖú Ï§ëÏã¨)Î•º Í≥ÑÏÇ∞
  const snap = layoutSnapshot.value;
  const usedMascotRect = snap?.mascotRect || mascotRect.value;
  const browserAbsoluteCenter = toAbsoluteFromMascot(equippedItem.relativePosition, usedMascotRect);

  // Ìï≠ÏÉÅ 'ÏïàÏ†ïÌôîÎêú' Ï∫îÎ≤ÑÏä§ ÏúÑÏπòÎ•º Ïö∞ÏÑ† ÏÇ¨Ïö© (Î†àÏù¥ÏïÑÏõÉ Î≥ÄÎèô Ïãú Ìäê Î∞©ÏßÄ)
  const canvasRect = (layoutSnapshot.value?.canvasRect) || stableCanvasRect || mascotCanvas.value.getBoundingClientRect();

  // ÏïÑÏù¥ÌÖúÏùò ÏÇ¨Ïù¥Ï¶à(Ïä§ÏºÄÏùº Î∞òÏòÅ)Î•º Í≥†Î†§ÌïòÏó¨ Ï§ëÏã¨ -> Ï¢åÏÉÅÎã®ÏúºÎ°ú Î≥¥Ï†ï
  const itemSize = BASE_ITEM_SIZE * (equippedItem.scale || 1);
  const half = itemSize / 2;
  let containerRelativePos = {
    x: browserAbsoluteCenter.x - canvasRect.left - half,
    y: browserAbsoluteCenter.y - canvasRect.top - half
  };

  // ÌôîÎ©¥ Î∞ñ ÏùºÎ∂Ä ÌóàÏö©(ÏûêÏú†ÎèÑ‚Üë): ÏïÑÏù¥ÌÖú ÌÅ¨Í∏∞Ïùò 10% ÎßåÌÅº Î∞îÍπ• ÌóàÏö©
  const allowOutsidePx = 0.1 * itemSize;
  const maxX = Math.max(-allowOutsidePx, canvasRect.width - itemSize + allowOutsidePx);
  const maxY = Math.max(-allowOutsidePx, canvasRect.height - itemSize + allowOutsidePx);
  containerRelativePos.x = Math.max(-allowOutsidePx, Math.min(maxX, containerRelativePos.x));
  containerRelativePos.y = Math.max(-allowOutsidePx, Math.min(maxY, containerRelativePos.y));
  
  // Í≥ÑÏÇ∞ Í≤∞Í≥ºÎ•º Ï∫êÏãúÏóê Ï†ÄÏû•
  positionCache.set(cacheKey, {
    x: containerRelativePos.x,
    y: containerRelativePos.y,
    timestamp: now
  });
  // ÏµúÏ¢Ö Î†åÎçî Ï¢åÌëú Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏(Ï†ÄÏû• Ï§ë ÌîåÎ¶¨Ïª§ Î∞©ÏßÄ)
  lastRenderedPosition.set(equippedItem.id, { x: containerRelativePos.x, y: containerRelativePos.y });

  return containerRelativePos;
}

// ÎßàÏä§ÏΩîÌä∏Îäî Ìï≠ÏÉÅ Ï∫îÎ≤ÑÏä§ Ï§ëÏïôÏóê Í≥†Ï†ï
function getMascotCenterPosition(): { x: number; y: number } {
  if (!mascotCanvas.value) {
    return { x: 0, y: 0 };
  }
  
  const containerSize = getContainerSize(mascotCanvas.value);
  return {
    x: containerSize.width / 2,
    y: containerSize.height / 2,
  };
}

// ÎßàÏä§ÏΩîÌä∏ bounding box ÏóÖÎç∞Ïù¥Ìä∏
function updateMascotRect() {
  if (mascotRef.value) {
    mascotRect.value = mascotRef.value.getBoundingClientRect();
    console.log('ÎßàÏä§ÏΩîÌä∏ bounding box ÏóÖÎç∞Ïù¥Ìä∏Îê®:', mascotRect.value);
    
    // ÎßàÏä§ÏΩîÌä∏ ÏúÑÏπò Î≥ÄÍ≤Ω Ïãú Ï∫îÎ≤ÑÏä§ Ï∫êÏãú Î¨¥Ìö®Ìôî
    stableCanvasRect = null;
    lastCanvasUpdateTime = 0;
    positionCache.clear();
    updateItemPositionDebounce.clear();
  }
}

// ÎßàÏä§ÏΩîÌä∏ ÎìúÎûòÍ∑∏ Í¥ÄÎ†® Ìï®ÏàòÎì§ Ï†úÍ±∞Îê® (ÎßàÏä§ÏΩîÌä∏Îäî Í≥†Ï†ï)

// ÎìúÎûòÍ∑∏ Í¥ÄÎ†® Î©îÏÜåÎìúÎì§
function updateCanvasBounds() {
  if (mascotCanvas.value) {
    const newBounds = mascotCanvas.value.getBoundingClientRect();
    
    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Í∞Ä Ïã§Ï†úÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÎäîÏßÄ ÌôïÏù∏
    const oldBounds = canvasBounds.value;
    const sizeChanged = !oldBounds ||
      Math.abs(oldBounds.width - newBounds.width) > 2 ||
      Math.abs(oldBounds.height - newBounds.height) > 2;
    const positionChanged = !oldBounds ||
      Math.abs(oldBounds.x - newBounds.x) > 8 ||
      Math.abs(oldBounds.y - newBounds.y) > 8;

    canvasBounds.value = newBounds;
    // Ï†ÑÍ≤Ω Î†àÏù¥Ïñ¥(z-20)Ïùò Í≤ΩÍ≥ÑÎèÑ Í∞±Ïã† (ÏóÜÏúºÎ©¥ Ï∫îÎ≤ÑÏä§ Í≤ΩÍ≥ÑÎ•º ÏÇ¨Ïö©)
    if (foregroundLayer.value) {
      foregroundBounds.value = foregroundLayer.value.getBoundingClientRect();
    } else {
      foregroundBounds.value = newBounds;
    }

    if (sizeChanged || positionChanged) {
      // ÏùòÎØ∏ÏûàÎäî Î≥ÄÍ≤ΩÏóêÎßå Ï∫êÏãú Î¨¥Ìö®Ìôî
      stableCanvasRect = null;
      lastCanvasUpdateTime = 0;
      if (!isSaving.value) {
        positionCache.clear();
        updateItemPositionDebounce.clear();
      }
      // ÎßàÏä§ÏΩîÌä∏ bounding boxÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏
      updateMascotRect();
    }
    
    // ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú ÏÉÅÎåÄ Ï¢åÌëú Í∏∞Î∞òÏúºÎ°ú ÏïÑÏù¥ÌÖú ÏúÑÏπò Ïû¨Í≥ÑÏÇ∞
    if (sizeChanged && oldBounds) {
      console.log('ÌôîÎ©¥ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Í∞êÏßÄ:', { 
        old: { width: oldBounds.width, height: oldBounds.height },
        new: { width: newBounds.width, height: newBounds.height }
      });
      
      // Î™®Îì† ÏïÑÏù¥ÌÖúÏùò Ï†àÎåÄ ÏúÑÏπòÎäî getAbsolutePositionÏóêÏÑú ÏÉÅÎåÄ Ï¢åÌëú Í∏∞Ï§ÄÏúºÎ°ú Ïû¨Í≥ÑÏÇ∞Îê®
    }
  }
}

// ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ ÎîîÎ∞îÏö¥Ïä§ (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
const updateItemPositionDebounce = new Map<string, number>();
// ÎìúÎûòÍ∑∏ Ïãú Îçî Î∂ÄÎìúÎü¨Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ Í∞ÑÍ≤©ÏùÑ Ï∂ïÏÜå (ÏïΩ 60fps ÏàòÏ§Ä)
const POSITION_UPDATE_DEBOUNCE = 16;

function updateItemPosition(itemId: string, position: { x: number; y: number }) {
  const state = equippedItemStates.value.get(itemId);
  if (!state || !mascotRect.value) return;
  
  // ÎîîÎ∞îÏö¥Ïä§ Ï≤òÎ¶¨
  const now = Date.now();
  const lastUpdate = updateItemPositionDebounce.get(itemId) || 0;
  
  if (now - lastUpdate < POSITION_UPDATE_DEBOUNCE) {
    // ÎîîÎ∞îÏö¥Ïä§Î°ú ÏóÖÎç∞Ïù¥Ìä∏ Ï∞®Îã® (Î°úÍπÖ ÏµúÏÜåÌôî)
    return;
  }
  
  updateItemPositionDebounce.set(itemId, now);
  
  // Ï∫îÎ≤ÑÏä§ ÏÉÅÎåÄ Ï¢åÌëú(position: Ï¢åÏÉÅÎã® Í∏∞Ï§Ä)Î•º Î∏åÎùºÏö∞Ï†Ä Ï†àÎåÄ Ï¢åÌëúÏùò 'ÏïÑÏù¥ÌÖú Ï§ëÏã¨'ÏúºÎ°ú Î≥ÄÌôò
  // Ìï≠ÏÉÅ ÏµúÏã† Ï∫îÎ≤ÑÏä§ ÏúÑÏπòÎ•º Ï∏°Ï†ïÌïòÏó¨ ÏÇ¨Ïö© (Ï†ÄÏû• ÏßÅÌõÑ Î†àÏù¥ÏïÑÏõÉ Î≥ÄÌôî ÎåÄÏùë)
  const snap = layoutSnapshot.value;
  const canvasRect = snap?.canvasRect || mascotCanvas.value?.getBoundingClientRect();
  const usedMascotRect = snap?.mascotRect || mascotRect.value;
  if (!canvasRect || !usedMascotRect) return;
  const itemSize = BASE_ITEM_SIZE * (state.scale || 1);
  const half = itemSize / 2;
  const absoluteCenter = {
    x: canvasRect.left + position.x + half,
    y: canvasRect.top + position.y + half,
  };

  // Î∏åÎùºÏö∞Ï†Ä Ï†àÎåÄ Ï¢åÌëú(Ï§ëÏã¨)Î•º ÎßàÏä§ÏΩîÌä∏ Í∏∞Ï§Ä ÏÉÅÎåÄ Ï¢åÌëúÎ°ú Î≥ÄÌôò
  let newRelativePosition = toRelativeToMascot(absoluteCenter, usedMascotRect);

  // ÎßàÏä§ÏΩîÌä∏ Í∏∞Ï§ÄÏúºÎ°ú ÏïÑÏù¥ÌÖúÏù¥ ÏòÅÏó≠ÏùÑ Í≥ºÎèÑÌïòÍ≤å Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù ÎäêÏä®Ìïú Ï†úÏïΩ Ï†ÅÏö© (Ï†Ñ ÌÉÄÏûÖ Í≥µÌÜµ ÏòµÏÖò)
  const itemSizePx = { width: BASE_ITEM_SIZE * (state.scale || 1), height: BASE_ITEM_SIZE * (state.scale || 1) };
  const looseOpts = { scaleDown: 0.05, outside: 0.4};
  newRelativePosition = constrainMascotRelativePositionLoose(newRelativePosition, itemSizePx, usedMascotRect, looseOpts);
  
  // ÏúÑÏπò Î≥ÄÍ≤ΩÏù¥ Ïã§Ï†úÎ°ú ÏûàÎäîÏßÄ ÌôïÏù∏ (ÎØ∏ÏÑ∏Ìïú Î≥ÄÌôî Î¨¥Ïãú)
  const oldPos = state.relativePosition;
  // Í∏∞Ï°¥ 0.1ÏùÄ Î≥ÄÌôî Ìè≠Ïù¥ ÏßÄÎÇòÏπòÍ≤å Ïª§ÏÑú ÏÑ∏Î∞ÄÌïú ÎìúÎûòÍ∑∏Í∞Ä Ïñ¥Î†µÎçò ÏõêÏù∏
  const POSITION_EPS = 0.005; // 0.5% Îã®ÏúÑÍπåÏßÄ Î∞òÏòÅ
  const positionChanged = Math.abs(oldPos.x - newRelativePosition.x) > POSITION_EPS || 
                         Math.abs(oldPos.y - newRelativePosition.y) > POSITION_EPS;
  
  if (!positionChanged) {
    // ÏùòÎØ∏ÏûàÎäî ÏúÑÏπò Î≥ÄÍ≤Ω ÏóÜÏùå (Î°úÍπÖ ÏµúÏÜåÌôî)
    return;
  }
  
  state.relativePosition = newRelativePosition;
  equippedItemStates.value.set(itemId, state);
  
  // ÏúÑÏπò Ï∫êÏãú Î¨¥Ìö®Ìôî
  positionCache.clear();
  
  console.log(`‚úÖ ÏïÑÏù¥ÌÖú ${itemId} ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏:`, {
    absolutePosition: position,
    relativeToMascot: state.relativePosition
  });
}

function updateItemScale(itemId: string, scale: number) {
  const state = equippedItemStates.value.get(itemId);
  if (state) {
    state.scale = scale;
    equippedItemStates.value.set(itemId, state);
  }
}

function updateItemRotation(itemId: string, rotation: number) {
  const state = equippedItemStates.value.get(itemId);
  if (state) {
    state.rotation = rotation;
    equippedItemStates.value.set(itemId, state);
  }
}

function selectItem(itemId: string) {
  selectedItemId.value = itemId;
  
  // ÏÑ†ÌÉù Ïãú Ï∫êÏãúÎäî Ïú†ÏßÄ (Î†àÏù¥ÏïÑÏõÉ Î≥ÄÌôîÍ∞Ä ÏóÜÏúºÎØÄÎ°ú)
  // positionCache.clear(); // Ï†úÍ±∞: Î∂àÌïÑÏöîÌïú Ï∫êÏãú Ï†ïÎ¶¨ Î∞©ÏßÄ
  // updateItemPositionDebounce.clear(); // Ï†úÍ±∞: ÏïàÏ†ïÏÑ± Ïú†ÏßÄ
  
  console.log('üéØ ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù:', itemId);
}

function handleCanvasClick(e: Event) {
  // Ï∫îÎ≤ÑÏä§ ÏòÅÏó≠ ÌÅ¥Î¶≠ Ïãú(ÏïÑÏù¥ÌÖúÏù¥ ÏïÑÎãå Í≤ΩÏö∞) ÏÑ†ÌÉù Ìï¥Ï†ú
  // DraggableItem Î£®Ìä∏ÏóêÏÑúÎäî @click.stop Ï≤òÎ¶¨ÎêòÏñ¥ Ïù¥ Ìï∏Îì§Îü¨Í∞Ä Ìò∏Ï∂úÎêòÏßÄ ÏïäÏùå
  selectedItemId.value = null;
}

// UI Í∞úÏÑ† Î©îÏÜåÎìúÎì§
// Î≤ÑÌäº Ìå®ÎÑê Ï†úÍ±∞Ïóê Îî∞Îùº Î≤ÑÌäº Í∏∞Î∞ò Ï°∞Ïûë Ìï®Ïàò Ï†úÍ±∞

// ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖú Ï†úÍ±∞
function removeSelectedItem() {
  if (selectedItemId.value) {
    removeEquippedItem(selectedItemId.value);
  }
}

// ÎßàÏä§ÏΩîÌä∏ ÏúÑÏπò Ï°∞Ïûë Ìï®ÏàòÎì§ Ï†úÍ±∞Îê® (ÎßàÏä§ÏΩîÌä∏Îäî Ï§ëÏïô Í≥†Ï†ï)

// ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ï≤òÎ¶¨ (Ï†úÌïú Ï≤¥ÌÅ¨ Ìè¨Ìï®)
function handleItemClick(item: Item) {
  const isCurrentlyEquipped = isItemEquipped(item);
  
  // Ïû•Ï∞© Ìï¥Ï†úÎäî Ìï≠ÏÉÅ Í∞ÄÎä•
  if (isCurrentlyEquipped) {
    toggleEquipItem(item);
    return;
  }
  
  // ÏÉàÎ°ú Ïû•Ï∞©Ìï† ÎïåÎäî Ï†úÌïú Ï≤¥ÌÅ¨
  if (!canEquipMoreItems.value) {
    showToastMessage(`ÏµúÎåÄ ${maxEquippedItems}Í∞úÍπåÏßÄÎßå Ïû•Ï∞©Ìï† Ïàò ÏûàÏäµÎãàÎã§! Î®ºÏ†Ä Îã§Î•∏ ÏïÑÏù¥ÌÖúÏùÑ Ï†úÍ±∞Ìï¥Ï£ºÏÑ∏Ïöî.`);
    return;
  }
  
  toggleEquipItem(item);
}

// Ï†ÑÏ≤¥ Ï°∞Ïûë Î©îÏÜåÎìúÎì§
function resetAllItems() {
  // ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ (Í∞ÑÎã®Ìïú confirm ÏÇ¨Ïö©)
  if (confirm('Î™®Îì† ÏïÑÏù¥ÌÖúÏùò ÏúÑÏπò, ÌÅ¨Í∏∞, ÌöåÏ†ÑÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
    equippedItemStates.value.clear();
    equippedItemsList.value = []; // Îã§Ï§ë ÏïÑÏù¥ÌÖú Î™©Î°ùÎèÑ Ï¥àÍ∏∞Ìôî
    selectedItemId.value = null;
    
    // currentMascot.equippedItem ÌïÑÎìú ÎèôÍ∏∞Ìôî
    updateMascotEquippedItems();
    
    // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Îã§Ïãú Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ïÎêòÎèÑÎ°ù Ìï®
    setTimeout(() => {
      showToastMessage('Î™®Îì† ÏïÑÏù¥ÌÖúÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§! üîÑ');
    }, 100);
  }
}

async function saveItemPositions() {
  try {
    // ÏÑúÎ≤Ñ Ï†ÄÏû•Ïö© Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
    const payload = {
      version: 'v1' as const,
      equippedItems: equippedItemsList.value.map(item => ({
        itemId: item.item.id,
        relativePosition: { x: item.relativePosition.x, y: item.relativePosition.y },
        scale: item.scale,
        rotation: item.rotation,
      })),
    };

    console.log('Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Ï†ÄÏû• ÏöîÏ≤≠:', payload);

          try {
        isSaving.value = true;
        // Ï†ÄÏû• ÏßÅÏ†Ñ Ïä§ÎÉÖÏÉ∑ ÏÉùÏÑ±(Data URL)
        const snapshot = await composeSnapshotDataUrl();
        await saveMascotCustomization({ ...payload, snapshotImageDataUrl: snapshot });
        // Î∞∞Í≤ΩÎèÑ Ìï®Íªò Ï†ÄÏû•ÌïòÏó¨ ÏùºÍ¥ÄÎêú Ï†ÄÏû• UX Ï†úÍ≥µ
        await updateMascotBackground({ backgroundColor: bgColor.value, patternType: bgPattern.value });
        showToastMessage('ÎßàÏä§ÏΩîÌä∏ Ïª§Ïä§ÌÑ∞ÎßàÏù¥ÏßïÏù¥ ÏÑúÎ≤ÑÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! üéØ‚ú®');

      // Ï†ÄÏû• ÏßÅÌõÑ Ìïú ÌîÑÎ†àÏûÑ Îí§Ïóê Ï∫îÎ≤ÑÏä§ Î∞îÏö¥ÎìúÎ•º Í∞±Ïã†ÌïòÏó¨ Ï¢åÌëú Ï∫êÏãúÎ•º ÏïàÏ†ïÌôî
      await nextTick();
      updateCanvasBounds();
    } catch (backendError) {
      console.error('Î∞±ÏóîÎìú Ï†ÄÏû• Ïã§Ìå®:', backendError);
      const errorMessage = handleApiError(backendError);
      showToastMessage(`ÏÑúÎ≤Ñ Ï†ÄÏû• Ïã§Ìå®: ${errorMessage}`);
    } finally {
      // Ï†ÄÏû• ÌîåÎûòÍ∑∏ Ìï¥Ï†ú Î∞è ÏïàÏ†ïÌôîÎêú rect Í≥†Ï†ï
      await nextTick();
      isSaving.value = false;
    }
    
  } catch (error) {
    console.error('Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ìå®:', error);
    showToastMessage('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
  }
}

// Ï†ÄÏû•Îêú ÏúÑÏπò Î∂àÎü¨Ïò§Í∏∞ (ÏôÑÏ†ÑÌïú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ìè¨Ìï®)
function loadItemPositions() {
  try {
    // ÏÑúÎ≤ÑÏóêÏÑú Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Î†àÏù¥ÏïÑÏõÉÏùÑ Î∂àÎü¨ÏòµÎãàÎã§.
    getMascotCustomization()
      .then((data) => {
        if (!data || !data.equippedItems) {
          console.log('ÏÑúÎ≤Ñ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï ÏóÜÏùå: Îπà ÏÉÅÌÉúÎ°ú ÏãúÏûë');
          return;
        }

        // ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ‚Üí Î∑∞ ÏÉÅÌÉúÎ°ú Ï†ÅÏö©
        equippedItemsList.value = data.equippedItems.map((entry) => {
          const item = items.value.find(i => i.id === entry.itemId);
          if (!item) return null;
          const id = generateItemId(item);
          const state: EquippedItemState = {
            id,
            item,
            relativePosition: { x: entry.relativePosition.x, y: entry.relativePosition.y },
            scale: entry.scale,
            rotation: entry.rotation,
            equippedAt: Date.now(),
          };
          equippedItemStates.value.set(id, state);
          return state;
        }).filter(Boolean) as EquippedItemState[];

        console.log('ÏÑúÎ≤Ñ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Î°úÎìúÎê®:', equippedItemsList.value);
      })
      .catch((err) => {
        console.error('ÏÑúÎ≤Ñ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Î°úÎìú Ïã§Ìå®:', err);
        const message = handleApiError(err);
        showToastMessage(`Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Î°úÎìú Ïã§Ìå®: ${message}`);
      });
  } catch (error) {
    console.error('ÏúÑÏπò Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
  }
}

// Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÏùò Ïù¥ÎØ∏ÏßÄ URL Í∞ÄÏ†∏Ïò§Í∏∞
function getEquippedItemImage(itemType: 'head' | 'clothing' | 'accessory' | 'background'): string | undefined {
  if (!currentMascot.value?.equippedItem) return undefined;
  
  // equippedItem Î¨∏ÏûêÏó¥ÏóêÏÑú Ìï¥Îãπ ÌÉÄÏûÖÏùò ÏïÑÏù¥ÌÖú Ï∞æÍ∏∞
  const equippedItem = items.value.find(item => 
    normalizeType(item.type) === itemType && 
    currentMascot.value!.equippedItem!.includes(item.name)
  );
  
  return equippedItem?.imageUrl;
}

// Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÏùò Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
function getEquippedItemName(itemType: 'head' | 'clothing' | 'accessory' | 'background'): string | undefined {
  if (!currentMascot.value?.equippedItem) return undefined;
  
  // equippedItem Î¨∏ÏûêÏó¥ÏóêÏÑú Ìï¥Îãπ ÌÉÄÏûÖÏùò ÏïÑÏù¥ÌÖú Ï∞æÍ∏∞
  const equippedItem = items.value.find(item => 
    normalizeType(item.type) === itemType && 
    currentMascot.value!.equippedItem!.includes(item.name)
  );
  
  return equippedItem?.name;
}

function isEquipped(item: Item): boolean {
  return isItemEquipped(item);
}

// Îí§Î°úÍ∞ÄÍ∏∞
function goBack() {
  // Î∞±ÏóîÎìúÏôÄ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞ÌôîÎêòÎØÄÎ°ú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏ Î∂àÌïÑÏöî
  // Î∞îÎ°ú Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
  router.push('/mascot');
}

// ÏïÑÏù¥ÌÖú Ïû•Ï∞©/Ìï¥Ï†ú ÌÜ†Í∏Ä (Îã§Ï§ë ÏïÑÏù¥ÌÖú ÏßÄÏõê)
async function toggleEquipItem(item: Item) {
  if (!currentMascot.value) return;
  
  try {
    const isCurrentlyEquipped = isItemEquipped(item);
    
    if (isCurrentlyEquipped) {
      // Ìï¥Ï†ú: Ìï¥Îãπ ÏïÑÏù¥ÌÖú Ï§ë ÌïòÎÇò Ï†úÍ±∞
      const equippedItem = equippedItemsList.value.find(equipped => equipped.item.id === item.id);
      if (equippedItem) {
        removeEquippedItem(equippedItem.id);
      }
    } else {
      // Ïû•Ï∞©: ÏÉà ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
      addEquippedItem(item);
    }
    
    // TODO: ÎÇòÏ§ëÏóê Î∞±ÏóîÎìú API Ìò∏Ï∂ú Ï∂îÍ∞Ä
    // const updatedMascot = await equipItems({ equippedItems: equippedItemsList.value });
    
    console.log('Îã§Ï§ë ÏïÑÏù¥ÌÖú Î≥ÄÍ≤Ω ÏôÑÎ£å:', equippedItemsList.value);
  } catch (error) {
    console.error('ÏïÑÏù¥ÌÖú Ïû•Ï∞©/Ìï¥Ï†ú Ïã§Ìå®:', error);
    
    // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
    const errorMessage = handleApiError(error);
    showToastMessage(`ÏïÑÏù¥ÌÖú Î≥ÄÍ≤Ω Ïã§Ìå®: ${errorMessage}`);
  }
}

// ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å Ï≤òÎ¶¨
function handleMascotImageLoad(event: Event) {
  console.log('ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å');
  // Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌõÑ ÎßàÏä§ÏΩîÌä∏ bounding box ÏóÖÎç∞Ïù¥Ìä∏
  nextTick(() => {
    updateMascotRect();
    console.log('ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌõÑ bounding box ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
  });
}

// ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ ÏóêÎü¨ Ï≤òÎ¶¨
function handleMascotImageError(event: Event) {
  const img = event.target as HTMLImageElement;
  img.src = '/mascot/soll.png'; // Í∏∞Î≥∏ ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄÎ°ú ÎåÄÏ≤¥
  console.error('ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', img.src);
}

// ÏïÑÏù¥ÌÖú Ïù¥ÎØ∏ÏßÄ ÏóêÎü¨ Ï≤òÎ¶¨
function handleImageError(event: Event) {
  const img = event.target as HTMLImageElement;
  img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjIwIiB5PSIyNCIgZmlsbD0iIzlDQTNBRiIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+üì¶PC90ZXh0Pgo8L3N2Zz4K';
}

// ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú
function showToastMessage(message: string) {
  toastMessage.value = message;
  showToast.value = true;
  
  setTimeout(() => {
    showToast.value = false;
  }, 2000);
}

// ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
async function loadMascotData() {
  try {
    console.log('Î∞±ÏóîÎìúÏóêÏÑú ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï©ÎãàÎã§...');
    
    const mascotData = await getMascot();
    if (mascotData) {
      currentMascot.value = mascotData;
      console.log('ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®:', mascotData);
      // Î∞∞Í≤Ω Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Ï¥àÍ∏∞Í∞í Ï†ÅÏö©
      if (mascotData.backgroundColor) {
        bgColor.value = mascotData.backgroundColor as string;
      }
      if (mascotData.backgroundPattern) {
        bgPattern.value = mascotData.backgroundPattern as any;
      }
      
      // Í∏∞Ï°¥ Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÎì§ Î°úÎìú (Ìò∏ÌôòÏÑ±)
      loadEquippedItemsFromMascot();
    } else {
      console.error('ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
      // ÎßàÏä§ÏΩîÌä∏Í∞Ä ÏóÜÏúºÎ©¥ Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
      router.push('/mascot');
    }
  } catch (error) {
    console.error('ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
    
    // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
    const errorMessage = handleApiError(error);
    showToastMessage(`ÎßàÏä§ÏΩîÌä∏ Î°úÎìú Ïã§Ìå®: ${errorMessage}`);
    
    // ÏóêÎü¨ Î∞úÏÉù Ïãú Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    setTimeout(() => {
      router.push('/mascot');
    }, 2000);
  }
}

// ÌôîÎ©¥ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Í∞êÏßÄÎ•º ÏúÑÌïú ResizeObserver
let resizeObserver: ResizeObserver | null = null;
let mascotResizeObserver: ResizeObserver | null = null;

// keep-aliveÎ°ú Î≥µÍ∑ÄÌñàÏùÑ Îïå Î≥¥Ïú† ÏïÑÏù¥ÌÖú ÏµúÏã†Ìôî
onActivated(async () => {
  try {
    await loadUserItems();
  } catch {}
});

// Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏
onMounted(async () => {
  console.log('ÎßàÏä§ÏΩîÌä∏ Íæ∏ÎØ∏Í∏∞ ÌéòÏù¥ÏßÄ Î°úÎìúÎê®');
  await loadMascotData();
  
  // Ï∫îÎ≤ÑÏä§ Î∞îÏö¥Îìú Î∞è ÎßàÏä§ÏΩîÌä∏ bounding box ÏóÖÎç∞Ïù¥Ìä∏
  await nextTick();
  // Ï¥àÍ∏∞ Ïä§ÎÉÖÏÉ∑ Ï∫°Ï≤ò(Í∞ôÏùÄ ÌîÑÎ†àÏûÑ Ï∏°Ï†ï)
  captureLayoutSnapshot(true);
  
  // ÏÇ¨Ïö©Ïûê Î≥¥Ïú† ÏïÑÏù¥ÌÖú Î°úÎìú Ï∂îÍ∞Ä
  await loadUserItems();
  
  // Ï†ÄÏû•Îêú ÏïÑÏù¥ÌÖú ÏúÑÏπò Î∂àÎü¨Ïò§Í∏∞
  await nextTick();
  loadItemPositions();
  

  
  // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
  window.addEventListener('resize', () => captureLayoutSnapshot());
  
  // ÎßàÏä§ÏΩîÌä∏ Ï∫îÎ≤ÑÏä§Ïùò ÌÅ¨Í∏∞ Î≥ÄÍ≤ΩÏùÑ Ï†ïÌôïÌïòÍ≤å Í∞êÏßÄÌïòÍ∏∞ ÏúÑÌï¥ ResizeObserver ÏÇ¨Ïö©
  if (mascotCanvas.value && 'ResizeObserver' in window) {
    resizeObserver = new ResizeObserver(() => {
      // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú ÎèôÍ∏∞ Ïä§ÎÉÖÏÉ∑ Ï∫°Ï≤ò
      nextTick(() => captureLayoutSnapshot());
    });
    resizeObserver.observe(mascotCanvas.value);
    console.log('ResizeObserverÍ∞Ä ÎßàÏä§ÏΩîÌä∏ Ï∫îÎ≤ÑÏä§Î•º Í∞êÏãúÌïòÍ∏∞ ÏãúÏûëÌñàÏäµÎãàÎã§.');
  }
  
  // ÎßàÏä§ÏΩîÌä∏ ÏöîÏÜå ÏûêÏ≤¥Ïùò ÌÅ¨Í∏∞ Î≥ÄÍ≤ΩÏùÑ Í∞êÏßÄÌïòÍ∏∞ ÏúÑÌïú ResizeObserver
  if (mascotRef.value && 'ResizeObserver' in window) {
    mascotResizeObserver = new ResizeObserver(() => {
      nextTick(() => {
        captureLayoutSnapshot();
        console.log('ÎßàÏä§ÏΩîÌä∏ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Í∞êÏßÄ - Ïä§ÎÉÖÏÉ∑ ÏóÖÎç∞Ïù¥Ìä∏Îê®');
      });
    });
    mascotResizeObserver.observe(mascotRef.value);
    console.log('ÎßàÏä§ÏΩîÌä∏ ResizeObserverÍ∞Ä ÎßàÏä§ÏΩîÌä∏ ÏöîÏÜåÎ•º Í∞êÏãúÌïòÍ∏∞ ÏãúÏûëÌñàÏäµÎãàÎã§.');
  }
  
  console.log('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏïÑÏù¥ÌÖúÎì§:', items.value);
});

// Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
onUnmounted(() => {
  window.removeEventListener('resize', updateCanvasBounds);
  
  // Canvas ResizeObserver Ï†ïÎ¶¨
  if (resizeObserver) {
    resizeObserver.disconnect();
    resizeObserver = null;
    console.log('Canvas ResizeObserver Ï†ïÎ¶¨ ÏôÑÎ£å');
  }
  
  // Mascot ResizeObserver Ï†ïÎ¶¨
  if (mascotResizeObserver) {
    mascotResizeObserver.disconnect();
    mascotResizeObserver = null;
    console.log('Mascot ResizeObserver Ï†ïÎ¶¨ ÏôÑÎ£å');
  }
});
</script>

<style scoped>
/* ÎùºÏù∏ ÌÅ¥Îû®ÌîÑ */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  line-clamp: 2;
  overflow: hidden;
}

/* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùºÎßÅ */
.overflow-x-auto::-webkit-scrollbar {
  height: 4px;
}

.overflow-x-auto::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 2px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Ïä§Î¨¥Ïä§ Ï†ÑÌôò */
.transition-all {
  transition: all 0.3s ease;
}

/* ÏïÑÏù¥ÌÖúÎ≥Ñ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
.item-head {
  width: 60%;
  height: 60%;
  top: -15%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
  object-fit: contain;
}

.item-accessory {
  width: 30%;
  height: 30%;
  top: 25%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 3;
  object-fit: contain;
}

.item-clothing {
  width: 80%;
  height: 80%;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
  object-fit: contain;
}
</style>
