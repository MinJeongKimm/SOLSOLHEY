<template>
  <div class="min-h-screen bg-gradient-to-br from-purple-100 via-blue-100 to-green-100 flex items-center justify-center p-4">
    <!-- Î©îÏù∏ Ïπ¥Îìú -->
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8">
      <!-- ÏÉÅÎã® Ìó§Îçî -->
      <div class="flex justify-between items-start mb-6">
        <!-- Ï¢åÏ∏°: My Room ÌÉÄÏù¥ÌãÄ -->
        <h1 class="text-xl font-bold text-gray-800">My Room</h1>
        
        <!-- Ïö∞Ï∏°: Ìè¨Ïù∏Ìä∏ & Ï¢ãÏïÑÏöî -->
        <div class="flex flex-col space-y-1">
          <!-- Ìè¨Ïù∏Ìä∏ -->
          <div class="flex items-center justify-end">
            <img src="/icons/icon_point.png" alt="Ìè¨Ïù∏Ìä∏" class="w-5 h-5 mr-2" />
            <span class="font-bold text-gray-900 min-w-[60px] text-center">{{ userCoins }}P</span>
          </div>
          <!-- Ï¢ãÏïÑÏöî -->
          <div class="flex items-center justify-end">
            <img src="/icons/icon_like.png" alt="Ï¢ãÏïÑÏöî" class="w-5 h-5 mr-2" />
            <span class="font-bold text-gray-900 min-w-[60px] text-center">{{ userLikes }}</span>
          </div>
        </div>
      </div>

      <!-- ÎßàÏä§ÏΩîÌä∏Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏÉùÏÑ± Î≤ÑÌäº -->
      <div v-if="!currentMascot" class="text-center py-8">
        <div class="text-6xl mb-4">ü•ö</div>
        <p class="text-gray-600 mb-4">ÏïÑÏßÅ ÎßàÏä§ÏΩîÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§</p>
        <button 
          @click="goToCreate"
          class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-medium transition-colors"
        >
          ÎßàÏä§ÏΩîÌä∏ ÏÉùÏÑ±ÌïòÍ∏∞
        </button>
      </div>

      <!-- ÎßàÏä§ÏΩîÌä∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞ Î©îÏù∏ ÏòÅÏó≠ -->
      <div v-else class="space-y-4">
        <!-- Î©îÏù∏ Ï∫îÎ≤ÑÏä§: Î∞© Î∞∞Í≤Ω + ÎßàÏä§ÏΩîÌä∏ -->
        <div class="relative">
          <!-- Î∞© Î∞∞Í≤Ω -->
          <div 
            class="w-full h-80 rounded-xl shadow-lg relative overflow-hidden flex items-center justify-center"
            style="background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%)"
          >
            <!-- Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ (ÌÅ¨Í∏∞ Ï°∞Ï†ï) -->
            <img 
              src="/backgrounds/base/bg_blue.png" 
              alt="Î∞© Î∞∞Í≤Ω" 
              class="w-3/4 h-3/4 object-contain"
            />
            
            <!-- ÎßàÏä§ÏΩîÌä∏ -->
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="relative">
                <!-- ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ (ÌÅ¨Í∏∞ ÌÇ§ÏõÄ) -->
                <img 
                  :src="getMascotImageUrl(currentMascot.type)" 
                  :alt="currentMascot.name" 
                  class="w-32 h-32 object-contain animate-float"
                  @error="handleImageError"
                />
                
                <!-- Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÎì§ (ÏÑúÎ≤Ñ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Í∏∞Î∞ò Î†åÎçî) -->
                <div class="absolute inset-0">
                  <img
                    v-for="ri in resolvedItems"
                    :key="ri.key"
                    :src="ri.src"
                    class="absolute object-contain pointer-events-none"
                    :style="{
                      left: ri.leftPct + '%',
                      top: ri.topPct + '%',
                      width: ri.sizePx + 'px',
                      height: ri.sizePx + 'px',
                      transform: `translate(-50%, -50%) rotate(${ri.rotation}deg)`,
                    }"
                  />

                  
                </div>
              </div>
            </div>
            
            <!-- ÎßàÏä§ÏΩîÌä∏ Ïù¥Î¶Ñ -->
            <div class="absolute top-3 left-3">
              <div class="bg-white bg-opacity-90 px-2 py-1 rounded-full">
                <span class="text-xs font-medium text-gray-800">{{ currentMascot.name }}</span>
              </div>
            </div>
            
            <!-- Í≥µÏú† Î≤ÑÌäº -->
            <div class="absolute top-3 right-3">
              <button 
                @click="showSharePopup"
                class="bg-white bg-opacity-90 p-1 rounded-lg hover:bg-opacity-100 transition-all flex items-center justify-center w-8 h-8"
              >
                <img src="/icons/icon_share.png" alt="Í≥µÏú†" class="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>

        <!-- Î†àÎ≤® Ïπ¥Îìú -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-2">
              <span class="text-xl">‚≠ê</span>
              <span class="text-lg font-bold text-gray-800">Lv.{{ currentMascot.level }}</span>
            </div>
            <span class="text-sm text-gray-500">{{ currentMascot.exp }} / {{ getNextLevelExp() }} XP</span>
          </div>
          
          <!-- Í≤ΩÌóòÏπò ÏßÑÌñâÎ∞î -->
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div 
              class="h-2 rounded-full transition-all duration-500"
              :style="{ 
                width: getExpPercentage() + '%',
                background: 'linear-gradient(90deg, #0046FF 0%, #4A90E2 100%)'
              }"
            ></div>
          </div>
        </div>

        <!-- ÌÄµ Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
        <div class="grid grid-cols-3 gap-3">
          <!-- Íæ∏ÎØ∏Í∏∞ -->
          <button 
            @click="goToCustomize"
            class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-3 flex flex-col items-center space-y-1 hover:shadow-md transition-all transform hover:scale-105"
          >
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
              <img src="/action/action_customize.png" alt="Íæ∏ÎØ∏Í∏∞" class="w-6 h-6" />
            </div>
            <span class="text-xs font-medium text-gray-700">Íæ∏ÎØ∏Í∏∞</span>
          </button>
          
          <!-- Ï±åÎ¶∞ÏßÄ -->
          <button 
            @click="goToChallenge"
            class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 flex flex-col items-center space-y-1 hover:shadow-md transition-all transform hover:scale-105"
          >
            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <span class="text-xs font-medium text-gray-700">Ï±åÎ¶∞ÏßÄ</span>
          </button>
          
          <!-- ÏáºÌïëÌïòÍ∏∞ -->
          <button 
            @click="goToShop"
            class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-3 flex flex-col items-center space-y-1 hover:shadow-md transition-all transform hover:scale-105"
          >
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
              <img src="/action/action_shop.png" alt="ÏáºÌïëÌïòÍ∏∞" class="w-6 h-6" />
            </div>
            <span class="text-xs font-medium text-gray-700">ÏáºÌïëÌïòÍ∏∞</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Í≥µÏú† ÌåùÏóÖ -->
    <div v-if="showShare" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
        <!-- ÌåùÏóÖ Ìó§Îçî -->
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-800">ÎßàÏä§ÏΩîÌä∏ Í≥µÏú†ÌïòÍ∏∞</h3>
          <button 
            @click="closeSharePopup"
            class="text-gray-400 hover:text-gray-600 text-2xl"
          >
            √ó
          </button>
        </div>

        <!-- Í≥µÏú† ÌÉÄÏûÖ ÏÑ†ÌÉù -->
        <div class="mb-4">
          <div class="flex space-x-2 mb-3">
            <button 
              @click="shareType = 'link'"
              :class="[
                'flex-1 py-2 px-4 rounded-lg font-medium transition-colors',
                shareType === 'link' 
                  ? 'bg-blue-500 text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              ]"
            >
              ÎßÅÌÅ¨ Í≥µÏú†
            </button>
            <button 
              @click="shareType = 'image'"
              :class="[
                'flex-1 py-2 px-4 rounded-lg font-medium transition-colors',
                shareType === 'image' 
                  ? 'bg-blue-500 text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              ]"
            >
              Ïù¥ÎØ∏ÏßÄ Í≥µÏú†
            </button>
          </div>
        </div>

        <!-- ÎßÅÌÅ¨ Í≥µÏú† Ìèº -->
        <div v-if="shareType === 'link'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Î©îÏãúÏßÄ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
            <textarea 
              v-model="shareLinkData.message" 
              placeholder="ÎßàÏä§ÏΩîÌä∏ÏôÄ Ìï®ÍªòÌïú Ïù¥ÏïºÍ∏∞Î•º Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî!"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="3"
            ></textarea>
          </div>
        </div>

        <!-- Ïù¥ÎØ∏ÏßÄ Í≥µÏú† Ìèº -->
        <div v-if="shareType === 'image'" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Î©îÏãúÏßÄ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
            <textarea 
              v-model="shareImageData.message" 
              placeholder="ÎßàÏä§ÏΩîÌä∏ÏôÄ Ìï®ÍªòÌïú Ïù¥ÏïºÍ∏∞Î•º Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî!"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="3"
            ></textarea>
          </div>
        </div>

        <!-- Í≥µÏú† Î≤ÑÌäº -->
        <div class="flex space-x-3 mt-6">
          <button 
            @click="closeSharePopup"
            class="flex-1 py-3 px-4 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors"
          >
            Ï∑®ÏÜå
          </button>
          <button 
            @click="handleShare"
            :disabled="!canShare"
            :class="[
              'flex-1 py-3 px-4 rounded-lg font-medium transition-colors',
              canShare 
                ? 'bg-blue-500 text-white hover:bg-blue-600' 
                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            ]"
          >
            Í≥µÏú†ÌïòÍ∏∞
          </button>
        </div>
      </div>
    </div>

    <!-- ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ -->
    <div 
      v-if="showToast" 
      class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all"
    >
      {{ toastMessage }}
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref, watch, nextTick } from 'vue';
import { useRouter } from 'vue-router';
import { auth, createShareImage, createShareLink, getAvailableTemplates, getMascot, handleApiError, ImageType, ShareType, getMascotCustomization, getShopItems, type ShareImageCreateRequest, type ShareLinkCreateRequest, type MascotCustomization } from '../api/index';
import type { ShopItem } from '../types/api';
import { levelExperience, mascotTypes } from '../data/mockData';
import { usePointStore } from '../stores/point';
import type { Mascot } from '../types/api';

const router = useRouter();

// Pinia Store ÏÇ¨Ïö©
const pointStore = usePointStore();

// Î∞òÏùëÌòï Îç∞Ïù¥ÌÑ∞
const currentMascot = ref<Mascot | null>(null);
// Ìè¨Ïù∏Ìä∏ ÏÉÅÌÉúÎäî StoreÏóêÏÑú Í¥ÄÎ¶¨
const userCoins = computed(() => pointStore.userPoints);
const userLikes = ref(151);

// ÏÑúÎ≤Ñ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï + ÏïÑÏù¥ÌÖú Ïπ¥ÌÉàÎ°úÍ∑∏ (ÎèôÍ∏∞ Î†åÎçî)
const customization = ref<MascotCustomization | null>(null);
const shopItems = ref<ShopItem[]>([]);
// Í≥ºÍ±∞ Ìè¥Î∞± Ï†úÍ±∞Îê®

// Î†åÎçîÎßÅÏö© ÌååÏÉù: ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Ïª§Ïä§ÌÑ∞ÎßàÏù¥ÏßïÏù¥ ÏûàÏúºÎ©¥ Ïù¥Î•º ÏÇ¨Ïö©
const BASE_ITEM_SIZE = 120; // Customize.vueÏôÄ ÎèôÏùº Í∏∞Ï§Ä
const resolvedItems = computed(() => {
  if (!customization.value || !customization.value.equippedItems?.length) return [] as Array<{
    key: string;
    src: string;
    leftPct: number;
    topPct: number;
    sizePx: number;
    rotation: number;
  }>;
  const byId = new Map<number, ShopItem>(shopItems.value.map(s => [s.id, s]));
  return customization.value.equippedItems
    .map((e, idx) => {
      const si = byId.get(e.itemId);
      if (!si) return null;
      return {
        key: `${e.itemId}-${idx}`,
        src: si.imageUrl,
        leftPct: e.relativePosition.x * 100,
        topPct: e.relativePosition.y * 100,
        sizePx: Math.max(24, BASE_ITEM_SIZE * (e.scale ?? 1)),
        rotation: ((e.rotation ?? 0) % 360 + 360) % 360,
      };
    })
    .filter(Boolean) as any[];
});

// ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º
const showToast = ref(false);
const toastMessage = ref('');

// Í≥µÏú† ÌåùÏóÖ Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞
const showShare = ref(false);
const shareType = ref<'link' | 'image'>('link');
const shareLinkData = ref({
  message: ''
});
const shareImageData = ref({
  message: ''
});

// Í≥µÏú† Í∞ÄÎä• Ïó¨Î∂Ä Í≥ÑÏÇ∞
const canShare = computed(() => {
  if (shareType.value === 'link') {
    return true; // ÎßÅÌÅ¨ Í≥µÏú†Îäî Ìï≠ÏÉÅ Í∞ÄÎä•
  } else {
    return true; // Ïù¥ÎØ∏ÏßÄ Í≥µÏú†ÎèÑ Ìï≠ÏÉÅ Í∞ÄÎä• (ÌÖúÌîåÎ¶ø ÏÑ†ÌÉùÏùÄ ÏÑ†ÌÉùÏÇ¨Ìï≠)
  }
});

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
function getMascotImageUrl(type: string): string {
  console.log('getMascotImageUrl Ìò∏Ï∂úÎê®:', { type });
  const typeObj = mascotTypes.find(t => t.id === type);
  const imageUrl = typeObj ? typeObj.imageUrl : '/mascot/soll.png';
  console.log('Í≤∞Ï†ïÎêú Ïù¥ÎØ∏ÏßÄ URL:', imageUrl);
  return imageUrl;
}

function handleImageError(event: Event) {
  const target = event.target as HTMLImageElement;
  target.src = '/mascot/soll.png'; // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú ÎåÄÏ≤¥
  console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', target.src);
}

function getMascotTypeDisplay(type: string): string {
  const typeObj = mascotTypes.find(t => t.id === type);
  return typeObj ? typeObj.name : type;
}

function getNextLevelExp(): number {
  if (!currentMascot.value) return 0;
  const nextLevel = currentMascot.value.level + 1;
  const levelData = levelExperience.find(l => l.level === nextLevel);
  return levelData ? levelData.requiredExp : 9999;
}

function getExpPercentage(): number {
  if (!currentMascot.value) return 0;
  const currentLevel = levelExperience.find(l => l.level === currentMascot.value!.level);
  const nextLevel = levelExperience.find(l => l.level === currentMascot.value!.level + 1);
  
  if (!currentLevel || !nextLevel) return 100;
  
  const currentExp = currentMascot.value.exp - currentLevel.requiredExp;
  const totalExp = nextLevel.requiredExp - currentLevel.requiredExp;
  
  return Math.min(100, (currentExp / totalExp) * 100);
}

// Ïû•Ï∞©Îêú ÏïÑÏù¥ÌÖúÏùò Ïù¥ÎØ∏ÏßÄ URL Í∞ÄÏ†∏Ïò§Í∏∞ (Î°úÏª¨ Ï†ÄÏû•ÏÜå Ìè¨Ìï®)

// Íæ∏ÎØ∏Í∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
function goToCustomize() {
  router.push('/mascot/customize');
}

// Ï±åÎ¶∞ÏßÄ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
function goToChallenge() {
  router.push('/challenge');
}

// ÎßàÏä§ÏΩîÌä∏ ÏÉùÏÑ± ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
function goToCreate() {
  router.push('/mascot/create');
}

// ÏÉÅÏ†ê ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
function goToShop() {
  router.push('/shop');
}

// ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú
function showToastMessage(message: string) {
  toastMessage.value = message;
  showToast.value = true;
  
  setTimeout(() => {
    showToast.value = false;
  }, 3000);
}

// Í≥µÏú† ÌåùÏóÖ ÌëúÏãú
function showSharePopup() {
  // ÌÜ†ÌÅ∞ ÏÉÅÌÉú ÌôïÏù∏
  if (!auth.isAuthenticated()) {
    showToastMessage('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
    setTimeout(() => {
      router.push('/');
    }, 2000);
    return;
  }
  
  showShare.value = true;
  shareType.value = 'link'; // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
  shareLinkData.value = { message: '' };
  shareImageData.value = { message: '' };
  
  // Î∞±ÏóîÎìú Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
  checkBackendStatus();
}

// Î∞±ÏóîÎìú Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
async function checkBackendStatus() {
  try {
    // Í≥µÏú† ÌÖúÌîåÎ¶ø Î™©Î°ùÏùÑ Ìò∏Ï∂úÌïòÏó¨ Î∞±ÏóîÎìú Ïó∞Í≤∞ ÌôïÏù∏
    await getAvailableTemplates();
    console.log('Î∞±ÏóîÎìú Ïó∞Í≤∞ ÏÉÅÌÉú: OK');
  } catch (error) {
    console.error('Î∞±ÏóîÎìú Ïó∞Í≤∞ Ïã§Ìå®:', error);
  }
}

// Í≥µÏú† ÌåùÏóÖ Îã´Í∏∞
function closeSharePopup() {
  showShare.value = false;
}

// Í≥µÏú† Ï≤òÎ¶¨
async function handleShare() {
  try {
    console.log('Í≥µÏú† ÏãúÏûë:', { shareType: shareType.value, currentMascot: currentMascot.value });
    
    if (shareType.value === 'link') {
      const message = shareLinkData.value.message || 'ÎÇòÏùò ÎßàÏä§ÏΩîÌä∏ÏôÄ Ìï®ÍªòÌïú Ïù¥ÏïºÍ∏∞Î•º Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî!';
      
      const shareUrl = `${window.location.origin}/mascot/${currentMascot.value?.id}`;
      const userNickname = auth.getUser()?.nickname || auth.getUser()?.username || 'ÎÇòÏùò';
      const mascotName = currentMascot.value?.name || 'ÎßàÏä§ÏΩîÌä∏';
      const shareTitle = `${userNickname}Ïùò ÎßàÏä§ÏΩîÌä∏ '${mascotName}'`;
      
      console.log('ÎßÅÌÅ¨ Í≥µÏú† ÏãúÎèÑ:', { shareTitle, message, shareUrl });
      
      try {
        // Î∞±ÏóîÎìú APIÎ°ú Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± (ÏÉàÎ°úÏö¥ ShareLinkCreateRequest Íµ¨Ï°∞)
        // Î∞±ÏóîÎìú validation Ï°∞Í±¥Ïóê ÎßûÏ∂∞ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
        const thumbnailUrl = currentMascot.value 
          ? `${window.location.origin}${getMascotImageUrl(currentMascot.value.type)}`
          : undefined;
        
        // validation Ï°∞Í±¥: title max 100Ïûê, description max 500Ïûê
        const validTitle = shareTitle.length > 100 ? shareTitle.substring(0, 100) : shareTitle;
        const validDescription = message.length > 500 ? message.substring(0, 500) : message;
        
        const shareLinkRequest: ShareLinkCreateRequest = {
          title: validTitle,
          description: validDescription || undefined,  // Îπà Î¨∏ÏûêÏó¥Ïù¥Î©¥ undefinedÎ°ú
          targetUrl: shareUrl,
          shareType: ShareType.GENERAL,  // ÎßàÏä§ÏΩîÌä∏ Í≥µÏú†Îäî GENERAL ÌÉÄÏûÖ ÏÇ¨Ïö©
          thumbnailUrl: thumbnailUrl
        };
        
        console.log('Î∞±ÏóîÎìúÎ°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞:', shareLinkRequest);
        
        const response = await createShareLink(shareLinkRequest);
        
        if (response.success) {
          // ÏÉùÏÑ±Îêú Í≥µÏú† ÎßÅÌÅ¨Î°ú Í≥µÏú†
          const shareUrl = response.data?.shareUrl || `${window.location.origin}/mascot/${currentMascot.value?.id}`;
          await navigator.share({
            title: shareTitle,
            text: message,
            url: shareUrl
          });
          showToastMessage('ÎßàÏä§ÏΩîÌä∏ ÎßÅÌÅ¨Í∞Ä ÏÉùÏÑ±ÎêòÏñ¥ Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§!');
        } else {
          showToastMessage('ÎßÅÌÅ¨ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í∏∞Î≥∏ ÎßÅÌÅ¨Î°ú Í≥µÏú†Ìï©ÎãàÎã§.');
          await navigator.share({
            title: shareTitle,
            text: message,
            url: shareUrl
          });
          showToastMessage('ÎßàÏä§ÏΩîÌä∏ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌñàÏäµÎãàÎã§!');
        }
      } catch (error) {
        console.error('ÎßÅÌÅ¨ ÏÉùÏÑ± Ïã§Ìå®:', error);
        
        // ÌÜ†ÌÅ∞ ÎßåÎ£å Ï≤¥ÌÅ¨
        if (error instanceof Error && 
            (error.message.includes('401') || error.message.includes('ÌÜ†ÌÅ∞Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§'))) {
          showToastMessage('Î°úÍ∑∏Ïù∏Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
          // ÌÜ†ÌÅ∞ ÎßåÎ£å Ïãú Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
          setTimeout(() => {
            auth.clearAuth();
            router.push('/');
          }, 2000);
          return;
        }
        
        showToastMessage('ÎßÅÌÅ¨ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í∏∞Î≥∏ ÎßÅÌÅ¨Î°ú Í≥µÏú†Ìï©ÎãàÎã§.');
        
        // ÏóêÎü¨ Î∞úÏÉù Ïãú Í∏∞Î≥∏ ÎßÅÌÅ¨ Í≥µÏú†Î°ú fallback
        await navigator.share({
          title: shareTitle,
          text: message,
          url: shareUrl
        });
        showToastMessage('ÎßàÏä§ÏΩîÌä∏ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌñàÏäµÎãàÎã§!');
      }
    } else {
      const message = shareImageData.value.message || 'ÎÇòÏùò ÎßàÏä§ÏΩîÌä∏ÏôÄ Ìï®ÍªòÌïú Ïù¥ÏïºÍ∏∞Î•º Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî!';
      
      console.log('Ïù¥ÎØ∏ÏßÄ Í≥µÏú† ÏãúÎèÑ:', { message });
      
      try {
        // ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ URL Ï§ÄÎπÑ (Ï†àÎåÄ URLÎ°ú Î≥ÄÌôò)
        const mascotImageUrl = currentMascot.value 
          ? `${window.location.origin}${getMascotImageUrl(currentMascot.value.type)}`
          : `${window.location.origin}/mascot/soll.png`;
        
        console.log('Î∞±ÏóîÎìú API Ìò∏Ï∂ú ÏãúÏûë:', {
          imageUrl: mascotImageUrl,
          imageType: ImageType.MASCOT_SHARE,
          isPublic: true
        });
        
        // Î∞±ÏóîÎìú APIÎ°ú Í≥µÏú† Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ÏÉàÎ°úÏö¥ ShareImageCreateRequest Íµ¨Ï°∞)
        const shareImageRequest: ShareImageCreateRequest = {
          imageUrl: mascotImageUrl,
          imageType: ImageType.MASCOT_SHARE,
          originalFilename: `mascot_${currentMascot.value?.name || 'unknown'}_share.png`,
          isPublic: true,
          width: 320,  // ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ Í∏∞Î≥∏ ÌÅ¨Í∏∞
          height: 320
        };
        
        const response = await createShareImage(shareImageRequest);
        
        console.log('Î∞±ÏóîÎìú API ÏùëÎãµ:', response);
        
        if (response.success) {
          // ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ URL Í∞ÄÏ†∏Ïò§Í∏∞
          const generatedImageUrl = response.data?.imageUrl;
          const userNickname = auth.getUser()?.nickname || auth.getUser()?.username || 'ÎÇòÏùò';
          const mascotName = currentMascot.value?.name || 'ÎßàÏä§ÏΩîÌä∏';
          const shareTitle = `${userNickname}Ïùò ÎßàÏä§ÏΩîÌä∏ '${mascotName}'`;
          
          try {
            // 1. fetchÏôÄ BlobÏùÑ ÏÇ¨Ïö©Ìï¥ÏÑú ÏõêÍ≤© URLÏóêÏÑú File Í∞ùÏ≤¥ ÏÉùÏÑ±
            console.log('Ïù¥ÎØ∏ÏßÄ ÌååÏùº Îã§Ïö¥Î°úÎìú ÏãúÏûë:', generatedImageUrl);
            const imageResponse = await fetch(generatedImageUrl);
            const imageBlob = await imageResponse.blob();
            
            // Ïù¥ÎØ∏ÏßÄ ÌååÏùº Í∞ùÏ≤¥ ÏÉùÏÑ±
            const imageFile = new File([imageBlob], `${mascotName}_share.png`, {
              type: imageBlob.type
            });
            
            console.log('Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÏÉùÏÑ± ÏôÑÎ£å:', imageFile);
            
            // 2. navigator.canShare()Î°ú ÌååÏùº Í≥µÏú† ÏßÄÏõê Ïó¨Î∂Ä ÌôïÏù∏
            if (navigator.canShare && navigator.canShare({ files: [imageFile] })) {
              // 3. ÌååÏùº Í≥µÏú† ÏßÄÏõê: title, text, url, files Î™®Îëê Ìè¨Ìï®Ìï¥ÏÑú Í≥µÏú†
              console.log('ÌååÏùº Í≥µÏú† ÏßÄÏõêÎê® - Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖçÏä§Ìä∏Î•º Ìï®Íªò Í≥µÏú†');
              await navigator.share({
                title: shareTitle,
                text: message,
                url: `${window.location.origin}/mascot/${currentMascot.value?.id}`,
                files: [imageFile]
              });
              showToastMessage('ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄÏôÄ Î©îÏãúÏßÄÍ∞Ä Ìï®Íªò Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§!');
            } else {
              // 4. ÌååÏùº Í≥µÏú† ÎØ∏ÏßÄÏõê: title, text, urlÎßå Í≥µÏú† (urlÏùÄ Ïù¥ÎØ∏ÏßÄ Î≥º Ïàò ÏûàÎäî ÌéòÏù¥ÏßÄ ÎßÅÌÅ¨)
              console.log('ÌååÏùº Í≥µÏú† ÎØ∏ÏßÄÏõê - ÌÖçÏä§Ìä∏ÏôÄ ÎßÅÌÅ¨Î°ú Í≥µÏú†');
              const imagePageUrl = `${window.location.origin}/mascot/${currentMascot.value?.id}`;
              await navigator.share({
                title: shareTitle,
                text: `${message}\nÏù¥ÎØ∏ÏßÄ: ${generatedImageUrl}`,
                url: imagePageUrl
              });
              showToastMessage('ÎßàÏä§ÏΩîÌä∏ Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌñàÏäµÎãàÎã§!');
            }
          } catch (fileError) {
            console.error('Ïù¥ÎØ∏ÏßÄ ÌååÏùº Ï≤òÎ¶¨ Ïã§Ìå®:', fileError);
            // ÌååÏùº Ï≤òÎ¶¨ Ïã§Ìå® Ïãú Í∏∞Î≥∏ ÎßÅÌÅ¨ Í≥µÏú†Î°ú fallback
            const fallbackUrl = `${window.location.origin}/mascot/${currentMascot.value?.id}`;
            await navigator.share({
              title: shareTitle,
              text: `${message}\nÏù¥ÎØ∏ÏßÄ: ${generatedImageUrl}`,
              url: fallbackUrl
            });
            showToastMessage('ÎßàÏä§ÏΩîÌä∏ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌñàÏäµÎãàÎã§!');
          }
        } else {
          showToastMessage('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎßÅÌÅ¨Î°ú Í≥µÏú†Ìï©ÎãàÎã§.');
          // Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå® Ïãú ÎßÅÌÅ¨ Í≥µÏú†Î°ú fallback
          const shareUrl = `${window.location.origin}/mascot/${currentMascot.value?.id}`;
          const userNickname = auth.getUser()?.nickname || auth.getUser()?.username || 'ÎÇòÏùò';
          const mascotName = currentMascot.value?.name || 'ÎßàÏä§ÏΩîÌä∏';
          const shareTitle = `${userNickname}Ïùò ÎßàÏä§ÏΩîÌä∏ '${mascotName}'`;
          
          await navigator.share({
            title: shareTitle,
            text: message,
            url: shareUrl
          });
          showToastMessage('ÎßàÏä§ÏΩîÌä∏ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌñàÏäµÎãàÎã§!');
        }
      } catch (error) {
        console.error('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
        
        // Îçî Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Ï†ïÎ≥¥ Î°úÍπÖ
        if (error instanceof Error) {
          console.error('ÏóêÎü¨ ÌÉÄÏûÖ:', error.name);
          console.error('ÏóêÎü¨ Î©îÏãúÏßÄ:', error.message);
          console.error('ÏóêÎü¨ Ïä§ÌÉù:', error.stack);
        }
        
        // ÏóêÎü¨ Ï¢ÖÎ•òÏóê Îî∞Î•∏ Î©îÏãúÏßÄ ÌëúÏãú
        let errorMessage = 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
        if (error instanceof Error) {
          if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Î∞±ÏóîÎìú ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
          } else if (error.message.includes('401') || error.message.includes('ÌÜ†ÌÅ∞Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§')) {
            errorMessage = 'Î°úÍ∑∏Ïù∏Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.';
            // ÌÜ†ÌÅ∞ ÎßåÎ£å Ïãú Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            setTimeout(() => {
              auth.clearAuth();
              router.push('/');
            }, 2000);
          } else if (error.message.includes('404')) {
            errorMessage = 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± APIÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.';
          }
        }
        
        showToastMessage(errorMessage + ' ÎßÅÌÅ¨Î°ú Í≥µÏú†Ìï©ÎãàÎã§.');
        
        // ÏóêÎü¨ Î∞úÏÉù Ïãú ÎßÅÌÅ¨ Í≥µÏú†Î°ú fallback
        const shareUrl = `${window.location.origin}/mascot/${currentMascot.value?.id}`;
        const userNickname = auth.getUser()?.nickname || auth.getUser()?.username || 'ÎÇòÏùò';
        const mascotName = currentMascot.value?.name || 'ÎßàÏä§ÏΩîÌä∏';
        const shareTitle = `${userNickname}Ïùò ÎßàÏä§ÏΩîÌä∏ '${mascotName}'`;
        
        await navigator.share({
          title: shareTitle,
          text: message,
          url: shareUrl
        });
        showToastMessage('ÎßàÏä§ÏΩîÌä∏ ÎßÅÌÅ¨Î•º Í≥µÏú†ÌñàÏäµÎãàÎã§!');
      }
    }
    closeSharePopup();
  } catch (error) {
    console.error('Í≥µÏú† Ïã§Ìå®:', error);
    
    // Îçî Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
    if (error instanceof Error) {
      if (error.name === 'AbortError') {
        showToastMessage('Í≥µÏú†Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
      } else if (error.name === 'NotAllowedError') {
        showToastMessage('Í≥µÏú† Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.');
      } else {
        showToastMessage(`Í≥µÏú† Ïã§Ìå®: ${error.message}`);
      }
    } else {
      showToastMessage('Í≥µÏú†Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  }
}

// ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
async function loadMascotData() {
  try {
    console.log('Î∞±ÏóîÎìúÏóêÏÑú ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï©ÎãàÎã§...'); // ÎîîÎ≤ÑÍπÖÏö©
    
    const mascotData = await getMascot();
    console.log('Î°úÎìúÎêú ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞:', mascotData); // ÎîîÎ≤ÑÍπÖÏö©
    
    if (mascotData) {
      currentMascot.value = mascotData;
      console.log('currentMascot ÏÑ§Ï†ï ÏôÑÎ£å:', currentMascot.value); // ÎîîÎ≤ÑÍπÖÏö©
      // ÏÑúÎ≤Ñ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï/ÏïÑÏù¥ÌÖú Ïπ¥ÌÉàÎ°úÍ∑∏ Î°úÎìú
      await Promise.all([
        (async () => { try { customization.value = await getMascotCustomization(); } catch { customization.value = null; } })(),
        (async () => { try { shopItems.value = await getShopItems(); } catch { shopItems.value = []; } })(),
      ]);
      await nextTick();
    } else {
      console.log('ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÏÉùÏÑ± ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.'); // ÎîîÎ≤ÑÍπÖÏö©
      // ÎßàÏä§ÏΩîÌä∏Í∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ± ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
      router.push('/mascot/create');
    }
  } catch (error) {
    console.error('ÎßàÏä§ÏΩîÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
    
    // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
    const errorMessage = handleApiError(error);
    showToastMessage(`ÎßàÏä§ÏΩîÌä∏ Î°úÎìú Ïã§Ìå®: ${errorMessage}`);
    
    // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏÉùÏÑ± ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    setTimeout(() => {
      router.push('/mascot/create');
    }, 2000);
  }
}

// currentMascot Î≥ÄÍ≤Ω Í∞êÏßÄ
watch(currentMascot, (newValue, oldValue) => {
  console.log('currentMascot Î≥ÄÍ≤ΩÎê®:', {
    oldValue,
    newValue,
    type: newValue?.type,
    name: newValue?.name
  });
}, { deep: true });

// (Ìè¥Î∞± Ï†úÍ±∞Îê®)

// Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏
onMounted(async () => {
  try {
    // Ìè¨Ïù∏Ìä∏ Î°úÎìú
    await pointStore.loadPoints();

    // ÎßàÏä§ÏΩîÌä∏ Ï†ïÎ≥¥ Î°úÎìú
    const mascotData = await getMascot();
    if (!mascotData) {
      router.push('/mascot/create');
      return;
    }
    currentMascot.value = mascotData;

    // Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï + ÏïÑÏù¥ÌÖú Ïπ¥ÌÉàÎ°úÍ∑∏ ÎèôÏãú Î°úÎìú
    const [cust, items] = await Promise.all([
      getMascotCustomization().catch(() => null),
      getShopItems().catch(() => []),
    ]);
    customization.value = cust;
    shopItems.value = items as any;
  } catch (err) {
    console.error('Î©îÏù∏ÌôîÎ©¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', err);
    handleApiError(err);
  }
});
</script>

<style scoped>
/* ÌîåÎ°úÌåÖ Ïï†ÎãàÎ©îÏù¥ÏÖò */
@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

.animate-float {
  animation: float 3s ease-in-out infinite;
}

/* Ïä§Î¨¥Ïä§ Ï†ÑÌôò */
.transition-all {
  transition: all 0.3s ease;
}

/* ÏïÑÏù¥ÌÖúÎ≥Ñ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
.item-head {
  width: 60%;
  height: 60%;
  top: -15%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
  object-fit: contain;
}

.item-accessory {
  width: 30%;
  height: 30%;
  top: 25%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 3;
  object-fit: contain;
}

.item-clothing {
  width: 80%;
  height: 80%;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
  object-fit: contain;
}
</style>
