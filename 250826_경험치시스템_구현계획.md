# 경험치(EXP) 시스템 구현 계획 (2025-08-26)

본 문서는 현재 레포지토리 상태를 기반으로 EXP 자동 적립 시스템의 현황 점검, ERD 제안, 서비스/API 설계, 프론트 반영 방향 및 단계별 구현 계획을 정리합니다. 기존 파일은 수정하지 않고 계획만 기술합니다.

## 1) 현황 점검(백엔드)
- 마스코트 도메인 보유: `Mascot(exp, level)` 및 조회/수정 API 존재.
  - 파일: `com.solsolhey.mascot.domain.Mascot`, `MascotController`, `MascotService(Impl)`
  - 수동 EXP 증가(`PATCH /api/v1/mascot`)는 가능하나 자동 이벤트 적립 로직은 없음.
- 출석 도메인: `Attendance` 엔티티에 `expReward`, `pointReward` 계산 로직 존재.
  - 파일: `user/entity/Attendance.java`, `user/service/AttendanceServiceImpl.java`
  - 현재는 출석 시 포인트 보너스만 `PointService.giveDailyBonus`로 지급. EXP는 마스코트에 반영하지 않음(자동 적립 미구현).
- 친구 상호작용: `FriendInteraction` 생성/조회 로직 존재.
  - 파일: `friend/service/FriendServiceImpl.java`, `friend/entity/FriendInteraction.java`
  - EXP 적립 로직 없음.
- 챌린지: 완료 시 포인트 보상 지급(`PointService.awardChallengeReward`)만 구현.
  - 파일: `challenge/service/ChallengeServiceImpl.java`
  - `Challenge` 엔티티에 `reward_exp` 컬럼이 있으나 EXP 보상 적용 로직은 없음. (요구사항상 챌린지는 포인트만 부여 계획)
- 공통: EXP 적립 이력/이벤트 테이블, 관련 서비스/레포지토리/컨트롤러, 전역 일일 제한 체크 로직 부재.
- 알림/팝업: EXP 적립 알림을 반환하는 전용 구조 없음(각 API 응답에 부가 정보로 포함하거나 별도 엔드포인트 필요).

결론: 자동 EXP 적립 시스템(규칙, 한도, 이력, API)은 현재 미구현 상태. 일부 보조 정보(Attendance의 보상 계산, Mascot의 exp/level)는 존재.

## 2) 요구사항 재정의(합의된 규칙 반영)
- 챌린지 보상: 포인트만 지급(학사/금융/소셜/이벤트 카테고리).
- EXP 자동 이벤트(사용자 동작 시 자동 적립, 사용자가 별도 수락 불필요):
  - 출석 참여: +5 EXP (하루 1회)
  - 7회 연속 출석 달성 시: 추가 +20 EXP (해당 달성 시 1회)
  - 친구 상호작용(친구 홈 방문, 공유하기 등): +3 EXP, 1일 최대 3회
  - 챌린지 카테고리별 “참여” 시: 카테고리당 하루 1회 +5 EXP (학사/금융/소셜/이벤트 각각)
- UX: 조건 충족 시 팝업/토스트 형태 알림(확인 버튼 없이 시각적 안내). 서버는 적립 발생 시 응답 페이로드에 ‘expAwarded’ 블록을 포함(간단 구현)하거나 별도의 알림 큐/엔드포인트 제공.

## 3) 제안 ERD
- 사용자/마스코트/출석은 기존 테이블 활용. 신규로 EXP 이력 테이블 1개 추가.

1) exp_event (신규)
- id (PK)
- user_id (FK → users.user_id)
- amount (int, >0)
- event_type (enum): ATTENDANCE, ATTENDANCE_STREAK7, FRIEND_INTERACTION, CHALLENGE_CATEGORY
- category (enum, nullable): FINANCE, ACADEMIC, SOCIAL, EVENT (챌린지 카테고리 이벤트 시 채움)
- reference_type (enum, nullable): ATTENDANCE, FRIEND, CHALLENGE, SHARE 등 식별용
- reference_id (bigint, nullable): 원천 엔티티(예: user_challenge_id, friend_interaction_id 등)
- description (varchar(200), nullable)
- metadata (text/json, nullable)
- created_at (datetime)

인덱스 제안:
- (user_id, event_type, created_at)
- (user_id, event_type, category, created_at)

비고:
- 일일 한도는 exp_event를 날짜 범위로 카운팅하여 판단(추가 별도 카운터 테이블 불필요). 성능 이슈 시 파생 카운터 고려.
- `Challenge.reward_exp`는 사용하지 않음(0 또는 무시). 스키마 변경은 추후 리팩토링에서 검토.

## 4) 서비스/도메인 설계
### 4.1 ExpService (신규)
- 책임: 규칙 검증(일일 한도/중복), EXP 적립, 마스코트 EXP 업데이트, 이력 저장, 알림 페이로드 생성.
- 메서드 예시:
  - awardAttendanceExp(User user, int consecutiveDays):
    - 오늘 출석 최초 시 +5 이벤트 기록(없으면 생성)
    - 7회 연속 달성 시 streak 이벤트(+20) 기록(해당 달성 당일 1회)
  - awardFriendInteractionExp(User user):
    - 오늘 FRIEND_INTERACTION 이벤트 수 < 3일 때 +3 기록
  - awardChallengeCategoryExp(User user, ChallengeCategory.CategoryType category):
    - 오늘 해당 카테고리 이벤트 없는 경우 +5 기록
  - 내부 공통: awardExp(User user, int amount, EventType type, ...ref) → 마스코트 EXP 증가 및 exp_event 저장, 알림 DTO 생성

### 4.2 통합 포인트/경험치 연동
- AttendanceServiceImpl.checkInToday → 저장 후 ExpService.awardAttendanceExp 호출(포인트 보너스 로직은 기존 유지)
- FriendServiceImpl.sendInteraction → 상호작용 저장 후 ExpService.awardFriendInteractionExp 호출
- ChallengeServiceImpl.joinChallenge → 참여/시작 성공 시 ExpService.awardChallengeCategoryExp 호출(완료가 아님; ‘참여’ 기준)

### 4.3 마스코트 연동
- MascotService에 마스코트 조회/생성 보장 로직 포함(없으면 생성 후 사용), `addExp()` 호출로 누적/레벨 갱신.

## 5) API 설계(백엔드)
- EXP는 자동 적립이므로 별도 “적립 요청” API는 불필요. 조회/서머리/알림 스펙만 추가.

1) GET /api/v1/exp/summary
- 응답: { totalExp, level, nextLevelExp, today: { attendance: {awarded:boolean}, friend:{count: n, remaining: 3-n}, categories: {FINANCE: boolean, ...} } }

2) GET /api/v1/exp/events?from=ISO&to=ISO&page&size
- 응답: 페이지네이션된 EXP 이력(이벤트 타입, 카테고리, amount, description, createdAt)

3) 기존 엔드포인트 응답 내 알림 페이로드(가벼운 방식)
- 출석/친구 상호작용/챌린지 참여 성공 시 서버가 다음 필드를 추가 반환:
  - expAwarded: { amount, reason, type, category?, totalExp, level }
- 프론트는 존재 시 토스트/팝업 표시(확인 버튼 없음).

보안/권한: 인증 사용자 본인 데이터만 접근.

## 6) 프론트 변경 방향(요청 사항 정리)
- 챌린지 화면의 “경험치 탭” 제거(혼동 방지: 챌린지는 포인트 보상만).
- 메인 화면 캐릭터(마스코트) 하단의 EXP/레벨 영역 클릭 시 EXP 이력/서머리 모달 오픈.
  - 초기 로딩: GET /api/v1/exp/summary
  - 탭/리스트: GET /api/v1/exp/events (최근 n건)
- 알림: 출석/상호작용/챌린지 참여 API 호출 후 응답의 `expAwarded` 있으면 즉시 토스트 표시.

## 7) 단계별 구현 계획
1. 도메인/스키마
   - `exp_event` 엔티티/레포지토리 추가, 마이그레이션 스크립트 작성.
   - 이벤트 타입/카테고리 enum 정의.
2. 서비스 계층
   - `ExpService`/`ExpServiceImpl` 구현(일일 한도/중복 체크, 마스코트 연동, 이력 저장).
   - 공통 유틸: 날짜 경계 조회(오늘 00:00~23:59:59), 카운팅 쿼리.
3. 기존 서비스 연동
   - AttendanceServiceImpl: 출석 성공 시 `ExpService.awardAttendanceExp` 호출 및 응답 페이로드에 `expAwarded` 포함.
   - FriendServiceImpl: 상호작용 생성 시 `awardFriendInteractionExp` 호출 및 `expAwarded` 포함.
   - ChallengeServiceImpl: 참여(join) 성공 시 `awardChallengeCategoryExp` 호출 및 `expAwarded` 포함.
4. 조회 API
   - `ExpController` 추가: summary/events 조회 엔드포인트 구현.
5. 프론트
   - 챌린지 화면 경험치 탭 제거.
   - 메인 마스코트 하단 EXP/레벨 클릭 → 모달에서 summary + events 노출.
   - 관련 API 연동 및 토스트 알림 처리.
6. 테스트/검증
   - 단위: ExpService 일일 한도/중복, 마스코트 레벨 계산.
   - 통합: 출석/상호작용/참여 플로우에서 EXP 이력 생성/알림 확인.

## 8) 고려사항 및 향후
- 퍼포먼스: `exp_event` 일자 범위 카운팅에 인덱스 설계로 대응. 트래픽 증가 시 per-day counter 캐시/집계 테이블 고려.
- 데이터 정합성: 각 트랜잭션 경계 내에서 EXP 적립과 원천 이벤트 저장이 함께 커밋되도록 설계.
- 마이그레이션: 기존 `Challenge.reward_exp`는 사용하지 않음. 생성 시 0을 기본값으로 유지하거나 UI에서 미표시.
- 알림 고도화: 필요 시 전용 `notification` 테이블과 읽음 처리 API 도입.

---
문의/보완점 있으면 알려주세요. 이 계획대로 진행 시, 먼저 엔티티/서비스 단부터 구현하고 기존 플로우에 인터셉트하는 방식으로 빠르게 통합 가능합니다.

