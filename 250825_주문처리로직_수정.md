# 250825_주문처리로직_수정

## 📋 작업 개요

**작업 일자**: 2025-08-25  
**작업 내용**: ShopServiceImpl의 주문처리 로직 수정  
**문제점**: 아이템 구매 시 "참조 타입이 있을 때는 참조 ID가 필요합니다" 에러 발생

## 🔍 문제 분석

### **에러 상황**
```
POST http://localhost:8080/api/v1/shop/orders 400 (Bad Request)
에러 메시지: "참조 타입이 있을 때는 참조 ID가 필요합니다"
```

### **문제 원인**
1. **비즈니스 로직 순서 문제**
   - 포인트 차감을 주문 생성 전에 시도
   - 주문이 생성되지 않았는데 포인트를 차감하려고 함

2. **Validation 로직 문제**
   - PointSpendRequest에서 referenceType이 있으면 referenceId도 필요
   - ShopServiceImpl에서 referenceType을 PURCHASE로 설정하고 referenceId를 null로 설정

3. **트랜잭션 관리 문제**
   - 포인트 차감 실패 시 주문도 롤백되지 않음

## 🎯 작업 계획

### **1단계: ShopServiceImpl.processItemOrder() 메서드 수정**

**현재 로직 (문제):**
```java
1. 포인트 차감 시도 (referenceId = null) ❌
2. 사용자 아이템 추가/수정
3. 주문 생성
```

**수정된 로직 (해결):**
```java
1. 주문 생성 (상태: PENDING)
2. 포인트 차감 (referenceId = 주문ID)
3. 사용자 아이템 추가/수정
4. 주문 상태를 COMPLETED로 변경
5. 포인트 차감 실패 시 주문 상태를 CANCELLED로 변경
```

### **2단계: 트랜잭션 관리 개선**
- `@Transactional` 어노테이션으로 전체 메서드 트랜잭션 관리
- 포인트 차감 실패 시 주문도 자동 롤백
- 데이터 일관성 보장

### **3단계: 에러 처리 개선**
- 구체적인 에러 메시지 제공
- 사용자에게 명확한 피드백 제공
- 로깅 개선

## 🔧 실제 작업 내용

### **수정된 파일**
- `backend/solsol/src/main/java/com/solsolhey/shop/service/ShopServiceImpl.java`

### **주요 수정 사항**

#### **1. processItemOrder() 메서드 로직 순서 변경**
```java
// 기존: 포인트 차감 → 사용자 아이템 처리 → 주문 생성
// 수정: 주문 생성 → 포인트 차감 → 사용자 아이템 처리 → 주문 상태 업데이트
```

#### **2. referenceId 올바르게 설정**
```java
// 기존
PointSpendRequest spendRequest = new PointSpendRequest(
    totalPrice, 
    "상품 구매: " + item.getName(), 
    null, // 주문 ID는 주문 생성 후 설정
    ReferenceType.PURCHASE
);

// 수정
PointSpendRequest spendRequest = new PointSpendRequest(
    totalPrice, 
    "상품 구매: " + item.getName(), 
    savedOrder.getId(), // 생성된 주문 ID 사용
    ReferenceType.PURCHASE
);
```

#### **3. 주문 상태 관리 개선**
```java
// 주문을 PENDING 상태로 생성
Order order = Order.builder()
    .userId(userId)
    .itemId(item.getId())
    .quantity(quantity)
    .totalPrice(totalPrice)
    .orderType(Order.OrderType.ITEM)
    .status(Order.OrderStatus.PENDING) // 초기 상태
    .build();

Order savedOrder = orderRepository.save(order);

// 포인트 차감 성공 시 주문 상태를 COMPLETED로 변경
savedOrder.setStatus(Order.OrderStatus.COMPLETED);
orderRepository.save(savedOrder);
```

## ✅ 작업 결과

### **수정 완료 사항**
1. ✅ ShopServiceImpl.processItemOrder() 메서드 로직 순서 변경
2. ✅ referenceId를 올바르게 설정
3. ✅ 주문 상태 관리 개선
4. ✅ 트랜잭션 관리 개선

### **테스트 결과**
- 아이템 구매 시 400 에러 해결
- 포인트 차감과 주문 생성이 올바른 순서로 처리
- 데이터 일관성 보장

### **향후 개선 사항**
1. 에러 처리 메시지 개선
2. 로깅 레벨 조정
3. 단위 테스트 추가

## 📝 결론

백엔드의 주문처리 로직을 수정하여 아이템 구매 기능이 정상 작동하게 되었습니다. 

**주요 성과:**
- 비즈니스 로직 순서 개선
- 데이터 무결성 보장
- 사용자 경험 향상

**학습 포인트:**
- 백엔드 로직 설계 시 비즈니스 순서 고려 필요
- Validation 로직의 일관성 확보 중요
- 트랜잭션 관리의 중요성
